package com.nms.model.ptn.qos;

import java.sql.Connection;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import com.nms.db.bean.ptn.qos.QosTemplateInfo;
import com.nms.db.dao.ptn.qos.QosTemplateDao;
import com.nms.model.util.ObjectService;
import com.nms.ui.manager.ExceptionManage;

public class QosTemplateService extends ObjectService {

	public void setConnection(Connection connection) {
		super.connection = connection;
	}

	public void setPtnuser(String ptnuser) {
		super.ptnuser = ptnuser;
	}

	private QosTemplateDao templateDao = new QosTemplateDao();

	/*
	 * 保存或更新模板
	 */
	public int saveOrUpdate(List<QosTemplateInfo> qosTemplateInfoList)
			throws Exception {

		if (qosTemplateInfoList == null || qosTemplateInfoList.size() == 0) {
			throw new Exception("qosTemplateInfoList is null");
		}
		String templateName = null;
		String qosType = null;
		int result = 0;
		List<Integer> idList = new ArrayList<Integer>();

		try {
			connection.setAutoCommit(false);
			templateName = qosTemplateInfoList.get(0).getTemplateName();
			qosType = qosTemplateInfoList.get(0).getQosType();
			for (QosTemplateInfo qosTemplate : qosTemplateInfoList) {
				if(qosTemplate.getId() != 0)
					idList.add(qosTemplate.getId());
			}
			if (!checkTemplateName(templateName, "")) {
				if (!checkIdListExsits(idList)) {
					for (QosTemplateInfo qosTemplate : qosTemplateInfoList) {
						templateDao.insert(qosTemplate, connection);
						result ++ ;
					}
				} else {
					for (QosTemplateInfo qosTemplate : qosTemplateInfoList) {
						templateDao.update(qosTemplate, connection);
						result ++ ;
					}
				}
			} else {
				templateDao.delete(templateName, qosType, connection);
				for (QosTemplateInfo qosTemplate : qosTemplateInfoList) {
					templateDao.update(qosTemplate, connection);
					result ++ ;
				}
			}
			if(!connection.getAutoCommit()){
				connection.commit();
			}
		} catch (Exception e) {
			connection.rollback();
			ExceptionManage.dispose(e,this.getClass());
		} finally {
			connection.setAutoCommit(true);
			templateName = null;
			qosType = null;
		}
		return result;
	}

	/*
	 * 根据模板名和类型删除
	 */
	public int delete(String templateName, String qosType) throws Exception {
		int result = 0;
		try {
			connection.setAutoCommit(false);
			result = templateDao.delete(templateName, qosType, connection);
			if(!connection.getAutoCommit()){
				connection.commit();
			}
		} catch (Exception e) {
			connection.rollback();
			ExceptionManage.dispose(e,this.getClass());
		} finally {
			connection.setAutoCommit(true);
		}
		return result;
	}

	/*
	 * 查询所有模板
	 */
	@SuppressWarnings("unchecked")
	public Map<String, List> selectAll() throws Exception {
		Map<String, List> templateInfoMap = new HashMap<String, List>();
		List<QosTemplateInfo> templateInfoList = new ArrayList<QosTemplateInfo>();
		List<QosTemplateInfo> templateInfoAllList = new ArrayList<QosTemplateInfo>();
		try {
			templateInfoAllList = templateDao.select(connection);
			for (QosTemplateInfo qosTemp : templateInfoAllList) {
				String tempName = qosTemp.getTemplateName();
				if (templateInfoMap.get(tempName) == null) {
					templateInfoList = new ArrayList<QosTemplateInfo>();
					for (QosTemplateInfo qos : templateInfoAllList) {
						if (qos.getTemplateName() == tempName) {
							templateInfoList.add(qos);
						}
					}
					templateInfoMap.put(tempName, templateInfoList);
				}
			}
		} catch (Exception e) {
			ExceptionManage.dispose(e,this.getClass());
		}
		return templateInfoMap;
	}

	/*
	 * 根据模板名和类型查询模板
	 */
	public List<QosTemplateInfo> queryByCondition(String templateName) throws Exception {
		List<QosTemplateInfo> templateInfoList = null;
		try {
			templateInfoList = templateDao.queryByCondition(templateName, connection);
		} catch (Exception e) {
			ExceptionManage.dispose(e,this.getClass());
		}
		return templateInfoList;
	}

	// 判断id是否存在
	private boolean checkIdListExsits(List<Integer> idList) throws Exception {
		List<QosTemplateInfo> list = null;
		try {
			if( idList != null && idList.size() != 0)
			list = templateDao.queryByIdList(idList, connection);
		} catch (Exception e) {
			ExceptionManage.dispose(e,this.getClass());
		}
		if (list != null && list.size() != 0) {
			return true;
		}
		return false;
	}

	// 判断模板名是否有冲突
	public boolean checkTemplateName(String templateName, String qosType)
			throws Exception {
		List<QosTemplateInfo> list = null;
		try {
			list = templateDao.queryByCondition(templateName,connection);
		} catch (Exception e) {
			ExceptionManage.dispose(e,this.getClass());
		}
		if (list != null && list.size() != 0) {
			return true;
		}

		return false;
	}
}
