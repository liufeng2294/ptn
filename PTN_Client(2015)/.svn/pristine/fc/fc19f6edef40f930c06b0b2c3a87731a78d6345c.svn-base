package com.nms.model.ptn.path.tunnel;

import java.sql.Connection;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import com.nms.db.bean.ptn.path.tunnel.Lsp;
import com.nms.db.bean.ptn.path.tunnel.Tunnel;
import com.nms.db.dao.ptn.path.tunnel.LspDao;
import com.nms.model.ptn.LabelInfoService;
import com.nms.model.util.ObjectService;
import com.nms.model.util.Services;
import com.nms.ui.manager.ConstantUtil;
import com.nms.ui.manager.ExceptionManage;

public class LspService extends ObjectService {

	public void setConnection(Connection connection) {
		super.connection = connection;
	}

	public void setPtnuser(String ptnuser) {
		super.ptnuser = ptnuser;
	}

	private LspDao lspParticularDao = new LspDao();

	/**
	 * 新增或修改lspparticular对象，通过lspparticular.getId()来判断是修改还是新增
	 * 
	 * @param lspparticular
	 *            实体
	 * @return 执行成功的记录数
	 * @throws Exception
	 */
	public int saveOrUpdate(Lsp lspparticular) throws Exception {

		if (lspparticular == null) {
			throw new Exception("lspparticular is null");
		}
		LabelInfoService labelService = null;
		int result = 0;
		try {

			if (lspparticular.getId() == 0) {
				result = this.lspParticularDao.insert(lspparticular, connection);
			} else {
				connection.setAutoCommit(false);
				result = this.lspParticularDao.update(lspparticular, connection);
			    labelService = (LabelInfoService) ConstantUtil.serviceFactory.newService(Services.LABELINFO, this.connection);
				// 修改两个网元的前向标签
//				labelService.updateBatch(lspparticular.getFrontLabelValue(), lspparticular.getASiteId(), 0, "TUNNEL");
				labelService.updateBatch(lspparticular.getFrontLabelValue(), lspparticular.getZSiteId(), 0, "TUNNEL");

				// 修改两个网元的后向标签
				labelService.updateBatch(lspparticular.getBackLabelValue(), lspparticular.getASiteId(), 0, "TUNNEL");
//				labelService.updateBatch(lspparticular.getBackLabelValue(), lspparticular.getZSiteId(), 0, "TUNNEL");

				if(!connection.getAutoCommit()){
					connection.commit();
				}
			}

		} catch (Exception e) {
			connection.rollback();
			ExceptionManage.dispose(e,this.getClass());
		} finally {
			connection.setAutoCommit(true);
		}
		return result;
	}

	/**
	 * 通过主键删除lspparticular 对象
	 * 
	 * @param id
	 *            主键
	 * @return 删除的记录数
	 * @throws Exception
	 */
	public int delete(int id) throws Exception {

		int result = 0;

		try {
			result = lspParticularDao.delete(id, connection);
		} catch (Exception e) {
			ExceptionManage.dispose(e,this.getClass());
		}
		return result;

	}

	/**
	 * 查询全部
	 * 
	 * @return List<LspParticular> 集合
	 * @throws Exception
	 */
	public List<Lsp> select() throws Exception {
		List<Lsp> lspparticularList = null;

		try {
			Lsp lspparticular = new Lsp();
			lspparticularList = lspParticularDao.queryByCondition(lspparticular, connection);
		} catch (Exception e) {
			ExceptionManage.dispose(e,this.getClass());
		}
		return lspparticularList;
	}

	/**
	 * 根据条件查询
	 * 
	 * @param lspparticular
	 *            查询条件
	 * @return List<LspParticular> 集合
	 * @throws Exception
	 */
	public List<Lsp> select(Lsp lspparticular) throws Exception {
		List<Lsp> lspparticularList = null;

		try {
			lspparticularList = lspParticularDao.queryByCondition(lspparticular, connection);
		} catch (Exception e) {
			ExceptionManage.dispose(e,this.getClass());
		}
		return lspparticularList;
	}

	/**
	 * 根据TunnelId查询
	 * 
	 * @param TunnelId
	 * @return List<LspParticular> 集合
	 * @throws Exception
	 */
	public List<Lsp> selectBytunnelId(int tunnelId) throws Exception {
		List<Lsp> lspparticularList = null;

		try {
			lspparticularList = lspParticularDao.queryByTunnnelId(tunnelId, connection);
		} catch (Exception e) {
			ExceptionManage.dispose(e,this.getClass());
		}
		return lspparticularList;
	}

	public List<Lsp> selectBySegmentId(int segmentId) throws Exception {
		List<Lsp> lspparticularList = null;

		try {
			lspparticularList = lspParticularDao.queryBySegmentId(segmentId, connection);
		} catch (Exception e) {
			ExceptionManage.dispose(e,this.getClass());
		}
		return lspparticularList;
	}

	public  Lsp select(int siteId, int tunnelServiceId, String type) throws Exception {
		Lsp lsp = null;
		try {
			lsp = this.lspParticularDao.queryBySiteIdAndTunnelserviceid(siteId, tunnelServiceId, type, connection);
		} catch (Exception e) {
			ExceptionManage.dispose(e,this.getClass());
		}
		return lsp;
	}

	public List<Lsp> selectBySiteIdAndTunnelId(int siteId, int tunnelId) throws Exception {
		List<Lsp> lspparticularList = null;
		try {
			lspparticularList = lspParticularDao.queryBySiteIdAndTunnelId(siteId, tunnelId, connection);
		} catch (Exception e) {
			ExceptionManage.dispose(e,this.getClass());
		}
		return lspparticularList;
	}

	public List<Lsp> selectBySiteId(int siteId) throws Exception {

		List<Lsp> lspparticularList = null;

		try {
			lspparticularList = lspParticularDao.queryBySiteId(siteId, connection);
		} catch (Exception e) {
			ExceptionManage.dispose(e,this.getClass());
		}
		return lspparticularList;
	}

	/**
	 * 同步时查询
	 * 
	 * @author kk
	 * @param roole
	 *            角色 "ingress"=A端 "egress"=z端 "xc"=中间节点 ""=武汉不确定是a还是z 所以同时比较az端
	 * @param siteid
	 *            网元id
	 * @param tunnel
	 *            tunnel对象
	 * @return
	 * @Exception 异常对象
	 */
	public List<Lsp> select_synchro(String role, int siteid, Tunnel tunnel) throws Exception {

		List<Lsp> lspparticularList = null;

		try {
			lspparticularList = lspParticularDao.querySychro(connection, role, siteid, tunnel);
		} catch (Exception e) {
			ExceptionManage.dispose(e,this.getClass());
		}
		return lspparticularList;
	}

	/**
	 * 根据网元id，初始化某网元lsp
	 * 
	 * @param siteId
	 * @throws SQLException
	 */
	public void initializtionSite(int siteId) throws SQLException {
		List<Lsp> lsps = null;
		try {
			lsps = this.selectBySiteId(siteId);
			if (lsps != null && lsps.size() > 0) {
				for (Lsp lsp : lsps) {
					if (lsp.getASiteId() == siteId) {
						lsp.setASiteId(0);
						lsp.setAlspbusinessid(0);
						lsp.setAPortId(0);
						lsp.setAtunnelbusinessid(0);
						lsp.setZoppositeId("0.0.0.0");
						lsp.setSegmentId(0);
					} else {
						lsp.setZSiteId(0);
						lsp.setZlspbusinessid(0);
						lsp.setZPortId(0);
						lsp.setZtunnelbusinessid(0);
						lsp.setAoppositeId("0.0.0.0");
						lsp.setSegmentId(0);
					}
					this.saveOrUpdate(lsp);
				}
			}
		} catch (Exception e) {
			ExceptionManage.dispose(e,this.getClass());
		} finally {
		}

	}

	/**
	 * 通过tunnelid查询出lsp集合 然后跟参数lspList进行比较
	 * 
	 * @param tunnelId
	 *            tunnel主键
	 * @param lspList
	 *            要比较的lsp集合
	 * @return true=路径相同 false=路径不同
	 * @throws Exception
	 */
	public boolean compareLsp(int tunnelId, List<Lsp> lspList) throws Exception {
		List<Lsp> lspList_select = null;
		boolean flag = true;
		Lsp lsp_select=null;	//lsp数据库对象
		Lsp lsp_ui=null;		//lsp界面对象
		try {
			// 通过tunnelid 查询出此tunnel下的lsp路径
			lspList_select = this.lspParticularDao.queryByTunnnelId(tunnelId, connection);
			
			//如果数量相同。才去比较路径是否一样
			if (lspList_select.size() == lspList.size()) {
				for (int i = 0; i < lspList_select.size(); i++) {
					lsp_select=lspList_select.get(i);
					lsp_ui=lspList.get(i);
					
					//如果正向比较不等的话。  就反向在比较
					if(!this.compareLsp(lsp_select, lsp_ui)){
						lsp_ui=lspList.get(lspList.size()-i-1);
						
						//如果反向比较也不等的话。就直接结束循环 返回界面
						if(!this.compareLsp(lsp_select, lsp_ui)){
							flag=false;
							break;
						}
					}
				}
			}else{
				flag=false;
			}
		} catch (Exception e) {
			throw e;
		} finally {
			lspList_select = null;
		}
		return flag;
	}

	/**
	 * 比较两个lsp是否为同样路径
	 * 
	 * @param lsp_select
	 * @param lsp_ui
	 * @return 相同返回true 不同返回false
	 */
	private boolean compareLsp(Lsp lsp_select, Lsp lsp_ui) throws Exception {

		// 比较asiteid zsiteid aportid zportid
		if ((lsp_select.getASiteId() == lsp_ui.getASiteId() && lsp_select.getZSiteId() == lsp_ui.getZSiteId() && lsp_select.getAPortId() == lsp_ui.getAPortId() && lsp_select.getZPortId() == lsp_ui.getZPortId()) || 
				(lsp_select.getASiteId() == lsp_ui.getZSiteId() && lsp_select.getZSiteId() == lsp_ui.getASiteId() && lsp_select.getAPortId() == lsp_ui.getZPortId() && lsp_select.getZPortId() == lsp_ui.getAPortId())) {
//			//比较标签
//			if(lsp_select.getFrontLabelValue() == lsp_ui.getFrontLabelValue() && lsp_select.getBackLabelValue() == lsp_ui.getBackLabelValue()){
				return true;
//			}else{
//				return false;
//			}
			
		} else {
			return false;
		}

	}
	
	/**
	 * 根据端口ID查询
	 * @param portId
	 * @return
	 * @throws Exception 
	 */
	public List<Lsp> selectByPort(int portId) throws Exception{
		return this.lspParticularDao.queryByPort(portId, connection);
	}

	/**
	 * 查询同一端口下标签是否可用
	 * @param portId
	 * @param label
	 * @return
	 * @throws Exception
	 */
	public boolean checkOutLabelUsable(int portId, int label) throws Exception{
		return this.lspParticularDao.queryOutLabelUsable(portId,label,connection);
	}

	/**
	 * 验证同一端口的lsp的入标签和该端口上的pw的入标签是否一样
	 * 一样返回false,不一样返回true
	 * @throws Exception 
	 */
	public boolean verifyInLabel(int siteId, int portId, int inLabel) throws Exception {
		List<Lsp> lspList = this.lspParticularDao.queryByPort(portId, connection);
		if(lspList != null && lspList.size() > 0){
			for (Lsp lsp : lspList) {
				if(lsp.getASiteId() == siteId){
					if(lsp.getBackLabelValue() == inLabel){
						return false;
					}
				}else if(lsp.getZSiteId() == siteId){
					if(lsp.getFrontLabelValue() == inLabel){
						return false;
					}
				}
			}
		}
		return true;
	}

	public List<Lsp> selectBusinessId(int siteId) throws Exception {
		List<Lsp> lspInfoList = this.lspParticularDao.selectBusinessId(siteId, connection);
		List<Lsp> lspList = new ArrayList<Lsp>();
		for (Lsp lsp : lspInfoList) {
			Lsp lspInfo = new Lsp();
			if(siteId == lsp.getASiteId()){
				lspInfo.setAtunnelbusinessid(lsp.getAtunnelbusinessid());
			}else if(siteId == lsp.getZSiteId()){
				lspInfo.setAtunnelbusinessid(lsp.getZtunnelbusinessid());
			}
			lspInfo.setTunnelId(lsp.getTunnelId());
			lspList.add(lspInfo);
		}
		return lspList;
	}

	/**
	 * 根据端口查询已用的lsp标签
	 */
	public Map<Integer, Integer> selectLspLabelByPort(List<Integer> portIdList) {
		Map<Integer, Integer> labelMap = new HashMap<Integer, Integer>();
		try {
			List<Lsp> lspList = this.lspParticularDao.queryByCondition(new Lsp(), connection);
			if(lspList != null){
				for (int portId : portIdList) {
					int count = 0;
					for (Lsp lsp : lspList) {
						if(portId == lsp.getAPortId() || portId == lsp.getZPortId()){
							count ++;
						}
					}
					labelMap.put(portId, count);
				}
			}
		} catch (Exception e) {
			ExceptionManage.dispose(e,this.getClass());
		}
		return labelMap;
	}

	public Map<Integer, Integer> selectLspLabelBySite(List<Integer> siteIdList) {
		Map<Integer, Integer> labelMap = new HashMap<Integer, Integer>();
		try {
			List<Lsp> lspList = this.lspParticularDao.queryByCondition(new Lsp(), connection);
			if(lspList != null){
				for (int siteId : siteIdList) {
					int count = 0;
					for (Lsp lsp : lspList) {
						if(siteId == lsp.getASiteId() || siteId == lsp.getZSiteId()){
							count ++;
						}
					}
					labelMap.put(siteId, count);
				}
			}
		} catch (Exception e) {
			ExceptionManage.dispose(e,this.getClass());
		}
		return labelMap;
	}
	
	public int queryTunnelIdBySiteIdAndBusiId(int siteId, int tunnelServiceId) throws Exception {
		return this.lspParticularDao.queryTunnelIdBySiteIdAndBusiId(siteId, tunnelServiceId, connection);	
	}
}
