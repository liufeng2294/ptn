package com.nms.model.system.roleManage;

import java.sql.Connection;
import java.util.ArrayList;
import java.util.List;

import com.nms.db.bean.system.roleManage.RoleInfo;
import com.nms.db.bean.system.roleManage.RoleManage;
import com.nms.db.bean.system.roleManage.RoleRelevance;
import com.nms.db.dao.system.loginlog.LoginLogDao;
import com.nms.db.dao.system.roleManage.RoleInfoDao;
import com.nms.db.dao.system.roleManage.RoleManageDao;
import com.nms.db.dao.system.roleManage.RoleRelevanceDao;
import com.nms.model.util.ObjectService;

/**
 * 操作角色 角色——权限 关联表
 * 
 * @author sy
 * 
 */
public class RoleInfoService extends ObjectService {

	public void setConnection(Connection connection) throws Exception {
		super.connection = connection;
	}

	public void setPtnuser(String ptnuser) {
		super.ptnuser = ptnuser;
	}

	RoleInfoDao roleInfoDao = new RoleInfoDao();
	RoleRelevanceDao roleRelevanceDao = new RoleRelevanceDao();
	List<RoleInfo> infoList = null;
	RoleRelevance roleRelevance = null;
	RoleManage roleManage = null;
	List<RoleRelevance> roleRelevanceList = new ArrayList<RoleRelevance>();

	/**
	 * 更新
	 * 
	 * @param roleInfo
	 *            roleInfo id 修改 角色 getRoleManageList 修改 关联表
	 * @return
	 * @throws Exception
	 */
	public int update(RoleInfo roleInfo) throws Exception {
		if (null == roleInfo) {
			throw new Exception("roleInfo is null");
		}
		int n = 0;
		LoginLogDao loginLogDao = null;
		try {
			this.connection.setAutoCommit(false);
			n = roleInfoDao.update(roleInfo, connection);
			// 调用关联删除 角色 ID
			roleRelevanceDao.delete(roleInfo, connection);
			// 调用关联新增
			if (null != roleInfo.getRoleManageList()) {
				for (int i = 0; i < roleInfo.getRoleManageList().size(); i++) {
					roleManage = roleInfo.getRoleManageList().get(i);
					roleRelevance = new RoleRelevance();
					roleRelevance.setInfoId(roleInfo.getId());
					roleRelevance.setManageId(roleManage.getId());
					roleRelevanceList.add(roleRelevance);
				}
			}
			roleRelevanceDao.insert(roleRelevanceList, connection);
			//强制注销此角色下的在线用户
			loginLogDao=new LoginLogDao();
			loginLogDao.updateByRole(roleInfo.getId(), super.connection);
			if(!this.connection.getAutoCommit()){
				this.connection.commit();
			}
		} catch (Exception e) {
			connection.rollback();
			throw e;
		} finally {
			connection.setAutoCommit(true);
			// 清楚内存
			loginLogDao = null;
		}

		return n;
	}

	/**
	 * 删除
	 * 
	 * @param roleInfoList
	 *            ID 删除 角色 批量删除 关联表，
	 * @return
	 * @throws Exception
	 */
	public int delete(List<RoleInfo> roleInfoList) throws Exception {
		if (null == roleInfoList) {
			throw new Exception("roleInfoList is null");
		}
		/**
		 * 根据 roleInfo 角色Id 先 删除 关联表（所有此 infoID ） 在删除 角色
		 */
		int result = 0;
		RoleInfo roleInfo = null;
		try {
			connection.setAutoCommit(false);
			for (int i = 0; i < roleInfoList.size(); i++) {
				roleInfo = roleInfoList.get(i);
				roleRelevanceDao.delete(roleInfo, connection);
				result = roleInfoDao.delete(roleInfo, connection);
			}
			if(!connection.getAutoCommit()){
				connection.commit();
			}
		} catch (Exception e) {
			connection.rollback();
			throw e;
		} finally {
			connection.setAutoCommit(true);
			roleInfo = null;
			// 清楚内存
		}

		return result;
	}

	/**
	 * 查看
	 * 
	 * @param roleInfo
	 *            Id角色
	 * @return 角色集合
	 * 
	 * @throws Exception
	 */
	public List<RoleInfo> select(RoleInfo roleInfo) throws Exception {
		RoleInfo info = null;
		List<RoleManage> roleManageList = null;
		RoleManageDao roleManageDao = new RoleManageDao();
		infoList = roleInfoDao.select(roleInfo, connection);
		// 遍历每个角色
		if (null != infoList) {
			for (int i = 0; i < infoList.size(); i++) {
				info = infoList.get(i);
				// 通过角色 ID 即 关联表中infoId查询关联表
				// 得到 角色 ——权限（关联）集合
				roleManageList = roleManageDao.byRoleInfoSelect(info, connection);
				// 遍历 关联表 集合
				// 将 权限 结合 添加 到 此次遍历的角色中

				info.setRoleManageList(roleManageList);
			}
		}
		// 清楚内存
		return infoList;
	}

	/**
	 * 新增
	 * 
	 * @param roleInfo
	 *            角色 ID 角色 权限 集合
	 * @return 新建 角色 个数
	 * @throws Exception
	 */
	public int insert(RoleInfo roleInfo) throws Exception {
		if (null == roleInfo) {
			throw new Exception("roleInfo is null");
		}
		// 新增 角色 反正值（主键ID）
		int result = 0;
		try {
			this.connection.setAutoCommit(false);
			result = roleInfoDao.insert(roleInfo, connection);
			// 遍历菜单
			if (null != roleInfo.getRoleManageList()) {
				for (int i = 0; i < roleInfo.getRoleManageList().size(); i++) {
					roleManage = roleInfo.getRoleManageList().get(i);
					// 创建关联对象
					roleRelevance = new RoleRelevance();
					roleRelevance.setInfoId(result);
					roleRelevance.setManageId(roleManage.getId());
					roleRelevanceList.add(roleRelevance);
				}
			}
			// 插入关联
			roleRelevanceDao.insert(roleRelevanceList, connection);
			if(!connection.getAutoCommit()){
				connection.commit();
			}
		} catch (Exception e) {
			connection.rollback();
			throw e;
		} finally {
			connection.setAutoCommit(true);
			// 清楚内存
			roleRelevance = null;
			roleRelevanceList = null;
			roleRelevanceDao = null;
			roleInfoDao = null;
		}
		return result;
	}

	/**
	 * 查看
	 * 
	 * @param roleInfo
	 *            Id角色
	 * @return 角色集合
	 * 
	 * @throws Exception
	 */
	public List<RoleInfo> selectNoName(RoleInfo roleInfo) throws Exception {
		if (null == roleInfo) {
			// 新增 时，，，角色不可重名
			infoList = roleInfoDao.select(roleInfo, connection);
		} else if (roleInfo.getId() > 0) {
			infoList = roleInfoDao.selectNoName(roleInfo, connection);
		}
		return infoList;
	}
}
