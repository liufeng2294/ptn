package com.nms.model.ptn.path.pw;

import java.sql.SQLException;
import java.text.ParseException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.apache.ibatis.session.SqlSession;

import com.nms.db.bean.ptn.Businessid;
import com.nms.db.bean.ptn.LabelInfo;
import com.nms.db.bean.ptn.oam.OamInfo;
import com.nms.db.bean.ptn.oam.OamMepInfo;
import com.nms.db.bean.ptn.oam.OamMipInfo;
import com.nms.db.bean.ptn.path.pw.MsPwInfo;
import com.nms.db.bean.ptn.path.pw.PwInfo;
import com.nms.db.bean.ptn.path.pw.PwNniInfo;
import com.nms.db.bean.ptn.path.tunnel.Tunnel;
import com.nms.db.bean.ptn.qos.QosInfo;
import com.nms.db.bean.ptn.qos.QosRelevance;
import com.nms.db.dao.ptn.BusinessidMapper;
import com.nms.db.dao.ptn.LabelInfoMapper;
import com.nms.db.dao.ptn.path.pw.MsPwInfoMapper;
import com.nms.db.dao.ptn.path.pw.PwInfoMapper;
import com.nms.db.dao.ptn.path.pw.PwNniInfoMapper;
import com.nms.db.dao.ptn.path.tunnel.TunnelMapper;
import com.nms.db.enums.EActionType;
import com.nms.db.enums.EManufacturer;
import com.nms.db.enums.EPwType;
import com.nms.db.enums.EServiceType;
import com.nms.db.enums.OamTypeEnum;
import com.nms.model.equipment.shlef.SiteService_MB;
import com.nms.model.ptn.LabelInfoService_MB;
import com.nms.model.ptn.oam.OamInfoService_MB;
import com.nms.model.ptn.path.tunnel.TunnelService_MB;
import com.nms.model.ptn.qos.QosInfoService_MB;
import com.nms.model.ptn.qos.QosRelevanceService_MB;
import com.nms.model.util.LabelManage;
import com.nms.model.util.ObjectService_Mybatis;
import com.nms.model.util.Services;
import com.nms.ui.manager.BusinessIdException;
import com.nms.ui.manager.ConstantUtil;
import com.nms.ui.manager.DateUtil;
import com.nms.ui.manager.ExceptionManage;
import com.nms.ui.manager.ResourceUtil;
import com.nms.ui.manager.UiUtil;
import com.nms.ui.manager.keys.StringKeysTip;

public class PwInfoService_MB extends ObjectService_Mybatis{
	public void setPtnuser(String ptnuser) {
		super.ptnuser = ptnuser;
	}

	public void setSqlSession(SqlSession sqlSession) {
		super.sqlSession = sqlSession;
	}
	
	private PwInfoMapper mapper;

	public PwInfoMapper getPwInfoMapper() {
		return mapper;
	}

	public void setPwInfoMapper(PwInfoMapper PwInfoMapper) {
		this.mapper = PwInfoMapper;
	}

	public PwInfo selectByPwId(int pwId) throws Exception {
		PwInfo pwInfo = null;
		try {
			pwInfo = new PwInfo();
			pwInfo.setPwId(pwId);
			List<PwInfo> pwInfoList = this.select(pwInfo);
			if (null != pwInfoList && pwInfoList.size() == 1) {
				pwInfo = pwInfoList.get(0);
			} else {
				throw new Exception("查询pw出错");
			}
		} catch (Exception e) {
			ExceptionManage.dispose(e,this.getClass());
		}
		return pwInfo;
	}
	
	public List<PwInfo> select(PwInfo pwinfoConditin) throws Exception {
		List<PwInfo> pwinfoList = null;
		PwNniInfo pwNniInfo = null;
		List<PwNniInfo> infos = null;
		MsPwInfo mspwinfoCondition = null;
		List<Tunnel> tunnels = null;
		List<PwInfo> pwInfoList1 = null;
		List<PwInfo> pwInfoList2 = null;
		try {
			pwinfoList = new ArrayList<PwInfo>();
			if(pwinfoConditin != null && pwinfoConditin.getType() != null){
				pwinfoConditin.setType_db(pwinfoConditin.getType().getValue());
			}
			pwInfoList1 = this.mapper.queryByCondition(pwinfoConditin);
			if(pwInfoList1 != null && pwInfoList1.size() > 0){
				for (PwInfo pwInfo : pwInfoList1) {
					pwInfo.setCreateTime(DateUtil.strDate(pwInfo.getCreateTime(), DateUtil.FULLTIME));
					pwInfo.setType(EPwType.forms(pwInfo.getType_db()));
				}
			}
			MsPwInfoMapper msPwMapper = this.sqlSession.getMapper(MsPwInfoMapper.class);
			//先通过端口号查tunnel，再通过tunnel查pw，然后过滤pw
			if(pwinfoConditin.getPortId() > 0)
			{
				TunnelMapper tunnelMapper = this.sqlSession.getMapper(TunnelMapper.class);
				tunnels = tunnelMapper.queryByportId(pwinfoConditin.getPortId());
				if(tunnels.size()>0)
				{
					List<Integer> tunnelIds = new ArrayList<Integer>();
					for(Tunnel tunnel:tunnels)
					{
						tunnelIds.add(tunnel.getTunnelId());
					}
					pwInfoList2 = this.mapper.queryByPwTunnelIdCondition(tunnelIds);
					for(PwInfo pw1 : pwInfoList1)
					{
						for(PwInfo pw2 : pwInfoList2)
						{
							if(pw2.getPwId() == pw1.getPwId())
							{
								pwinfoList.add(pw1);
							}
						}
					}
				}
			}
			else
			{
				pwinfoList.addAll(pwInfoList1);
			}
			PwNniInfoMapper pwNniMapper = this.sqlSession.getMapper(PwNniInfoMapper.class);
			for (PwInfo pwInfo : pwinfoList) {// 封装对应的pwnniInfo
				mspwinfoCondition = new MsPwInfo();
				mspwinfoCondition.setPwId(pwInfo.getPwId());
				pwNniInfo = new PwNniInfo();
				pwNniInfo.setPwId(pwInfo.getPwId());
				infos = pwNniMapper.queryByCondition(pwNniInfo);
				for (PwNniInfo info : infos) {
					if (info.getSiteId() == pwInfo.getASiteId() && pwInfo.getApwServiceId() != 0) {
						pwInfo.setaPwNniInfo(info);
					}
					if (info.getSiteId() == pwInfo.getZSiteId() && pwInfo.getZpwServiceId() != 0) {
						pwInfo.setzPwNniInfo(info);
					}
				}
				pwInfo.setMsPwInfos(msPwMapper.queryByCondition(mspwinfoCondition));
			}
			this.getOAMandQoSforPw(pwinfoList);
		} catch (Exception e) {
			ExceptionManage.dispose(e,this.getClass());
		}
		return pwinfoList;
	}
	
	private void getOAMandQoSforPw(List<PwInfo> pwList) {
		OamInfoService_MB oamInfoService = null;
		QosInfoService_MB qosInfoService = null;
		OamInfo oamInfo = null;
		OamMepInfo oamMepInfo = null;
		OamMipInfo oamMipInfo = null;
		PwNniInfo pwNniInfo = null;
		List<PwNniInfo> pwNniInfoList = null;
		try {
			qosInfoService = (QosInfoService_MB) ConstantUtil.serviceFactory.newService_MB(Services.QosInfo, this.sqlSession);
			oamInfoService = (OamInfoService_MB) ConstantUtil.serviceFactory.newService_MB(Services.OamInfo, this.sqlSession);
			for (PwInfo pw : pwList) {
				oamInfo = new OamInfo();
				oamMepInfo = new OamMepInfo();
				oamMepInfo.setServiceId(pw.getPwId());
				oamMepInfo.setObjType("PW");
				oamInfo.setOamMep(oamMepInfo);
				oamMipInfo = new OamMipInfo();
				oamMipInfo.setServiceId(pw.getPwId());
				oamMipInfo.setObjType("PW");
				oamInfo.setOamMip(oamMipInfo);
				pw.setOamList(oamInfoService.queryByServiceId(oamInfo));
				// 查询qos
				pw.setQosList(qosInfoService.getQosByObj(EServiceType.PW.toString(), pw.getPwId()));
				//查询pw的vlan信息
				PwNniInfoMapper pwNniMapper = this.sqlSession.getMapper(PwNniInfoMapper.class);
				//查询此pw下的所有vlan信息
				pwNniInfo = new PwNniInfo();
				pwNniInfo.setPwId(pw.getPwId());
				pwNniInfoList = pwNniMapper.queryByCondition(pwNniInfo);
				//因为pw只有az两端  所以pwvlan信息最多又两个记录
				if( null != pwNniInfo && pwNniInfoList.size()>0 && pwNniInfoList.size()<2){
					for(PwNniInfo pwNniInfo_select : pwNniInfoList){
						if(pwNniInfo_select.getSiteId()==pw.getASiteId()){
							pw.setaPwNniInfo(pwNniInfo_select);
							continue;
						}
						if(pwNniInfo_select.getSiteId()==pw.getZSiteId()){
							pw.setzPwNniInfo(pwNniInfo_select);
							continue;
						}
					}
				}
			}
		} catch (Exception e) {
			ExceptionManage.dispose(e,this.getClass());
		}
	}

	public Object selectFilter(PwInfo filterPwInfo) {
		List<PwInfo> pwInfos = new ArrayList<PwInfo>();
		List<PwInfo> infos = null;
		Map<Integer,Tunnel> integers = null;
		TunnelService_MB tunnelService = null;
		PwNniInfo pwNniInfo = null;
		List<PwNniInfo> pwNniInfos = null;
		try {
			if(filterPwInfo != null && filterPwInfo.getType() != null){
				filterPwInfo.setType_db(filterPwInfo.getType().getValue());
			}
			infos = this.mapper.queryFilte(filterPwInfo);
			List<PwInfo> pwList = new ArrayList<PwInfo>();
			if(infos != null && !infos.isEmpty()){
				for (PwInfo pwInfo : infos) {
					pwInfo.setCreateTime(DateUtil.strDate(pwInfo.getCreateTime(), DateUtil.FULLTIME));
					pwInfo.setType(EPwType.forms(pwInfo.getType_db()));
					if(filterPwInfo.getIsSingle() == pwInfo.getIsSingle()){
						pwList.add(pwInfo);
					}
				}
				infos.clear();
				infos.addAll(pwList);
			}
			tunnelService = (TunnelService_MB) ConstantUtil.serviceFactory.newService_MB(Services.Tunnel, this.sqlSession);
			//根据端口查询所有tunnel
			if(filterPwInfo.getPortId()>0){
				List<Tunnel> tunnels = tunnelService.selectByPortIdAndSiteId(filterPwInfo.getASiteId(), filterPwInfo.getPortId());
				integers = new HashMap<Integer,Tunnel>();
				for(Tunnel tunnel :tunnels){
					integers.put(tunnel.getTunnelId(), tunnel);
				}
			}
			//根据tunnelid过滤
			if(filterPwInfo.getTunnelId()>0){
				if(integers == null){
					for(PwInfo pwInfo : infos){
						if(pwInfo.getTunnelId() == filterPwInfo.getTunnelId()){
							pwInfos.add(pwInfo);
						}	
					}
				}else{
					Tunnel tunnel = integers.get(filterPwInfo.getTunnelId());
					if(tunnel != null){
						for(PwInfo pwInfo : infos){
							if(pwInfo.getTunnelId() == tunnel.getTunnelId()){
								pwInfos.add(pwInfo);
							}	
						}
					}else{
						return pwInfos;
					}
				}
			}else{
				if(integers != null){
					for(PwInfo pwInfo : infos){
						if(integers.get(pwInfo.getTunnelId()) != null){
							pwInfos.add(pwInfo);
						}	
					}
				}else{
					pwInfos = infos;
				}
			}
			PwNniInfoMapper pwNniMapper = this.sqlSession.getMapper(PwNniInfoMapper.class);
			for (PwInfo pwInfo : pwInfos) {// 封装对应的pwnniInfo
				pwNniInfo = new PwNniInfo();
				pwNniInfo.setPwId(pwInfo.getPwId());
				pwNniInfos = pwNniMapper.queryByCondition(pwNniInfo);
				for (PwNniInfo info : pwNniInfos) {
					if (info.getSiteId() == pwInfo.getASiteId() && pwInfo.getApwServiceId() != 0) {
						pwInfo.setaPwNniInfo(info);
					}
					if (info.getSiteId() == pwInfo.getZSiteId() && pwInfo.getZpwServiceId() != 0) {
						pwInfo.setzPwNniInfo(info);
					}
				}
			}
			this.getOAMandQoSforPw(pwInfos);
		} catch (Exception e) {
			ExceptionManage.dispose(e, this.getClass());
		}
		return pwInfos;
	}

	/**
	 * 通过主键查询pw对象
	 * 只提供给多段PW来查询
	 * lable = 1 查询单站 否则查询所有
	 * @param pwId
	 * @return
	 * @throws Exception
	 */ 
	public PwInfo selectByPwIdForMulti(int pwId,int lable) throws Exception {
		List<PwInfo> pwInfoList = null;
		PwInfo pwInfo = null;
		try {
			pwInfo = new PwInfo();
			pwInfo.setPwId(pwId);
			pwInfo.setIsSingle(lable);
			pwInfoList = this.mapper.selectByPWId(pwInfo);   //selectByPWId
			if (null != pwInfoList && pwInfoList.size() == 1) {
				if(pwInfoList != null && pwInfoList.size() > 0){
					for (PwInfo pwinfo : pwInfoList) {
						pwinfo.setType(EPwType.forms(pwinfo.getType_db()));
						pwinfo.setCreateTime(DateUtil.strDate(pwinfo.getCreateTime(), DateUtil.FULLTIME));
					}
				}
				pwInfo = pwInfoList.get(0);
			} else {
				throw new Exception("查询pw出错");
			}
			pwInfo.setCreateTime(DateUtil.strDate(pwInfo.getCreateTime(), DateUtil.FULLTIME));
			pwInfo.setType(EPwType.forms(pwInfo.getType_db()));
		} catch (Exception e) {
			ExceptionManage.dispose(e, this.getClass());
		} finally {
			pwInfoList = null;
		}
		return pwInfo;
	}

	public List<PwInfo> selectBySiteId_network(int siteId) {
		List<PwInfo> pwlList = null;
		try {
			PwInfo condition = new PwInfo();
			condition.setASiteId(siteId);
			condition.setIsSingle(0);
			pwlList = this.mapper.queryPwBySiteIdAndIsSingle(condition);
			if(pwlList != null && pwlList.size() > 0){
				for (PwInfo pwInfo : pwlList) {
					pwInfo.setCreateTime(DateUtil.strDate(pwInfo.getCreateTime(), DateUtil.FULLTIME));
					pwInfo.setType(EPwType.forms(pwInfo.getType_db()));
				}
			}
			this.getOAMandQoSforPw(pwlList);
		} catch (Exception e) {
			ExceptionManage.dispose(e,this.getClass());
		}
		return pwlList;
	}

	public PwInfo selectBypwid_notjoin(PwInfo pwinfo) {
		PwInfo pwInfo = null;
		List<PwInfo> pwInfoList = null;
		PwNniInfo pwNniInfo = null;
		List<PwNniInfo> infos = null;
		MsPwInfo mspwinfoCondition = null;
		try {
			PwNniInfoMapper pwNniMapper = this.sqlSession.getMapper(PwNniInfoMapper.class);
			pwInfo = this.mapper.queryByPwidCondition_notjoin(pwinfo);
			if(pwInfo != null){
				pwinfo.setType(EPwType.forms(pwinfo.getType_db()));
				pwinfo.setCreateTime(DateUtil.strDate(pwInfo.getCreateTime(), DateUtil.FULLTIME));
			}
			pwInfoList = new ArrayList<PwInfo>();
			pwInfoList.add(pwInfo);
			MsPwInfoMapper msPwMapper = this.sqlSession.getMapper(MsPwInfoMapper.class);
			for (PwInfo pwInfo2 : pwInfoList) {// 封装对应的pwnniInfo
				pwNniInfo = new PwNniInfo();
				pwNniInfo.setPwId(pwInfo.getPwId());
				mspwinfoCondition = new MsPwInfo();
				mspwinfoCondition.setPwId(pwInfo.getPwId());
				infos = pwNniMapper.queryByCondition(pwNniInfo);
				for (PwNniInfo info : infos) {
					if (info.getSiteId() == pwInfo2.getASiteId() && pwInfo2.getApwServiceId() != 0) {
						pwInfo.setaPwNniInfo(info);
					}
					if (info.getSiteId() == pwInfo2.getZSiteId() && pwInfo2.getZpwServiceId() != 0) {
						pwInfo.setzPwNniInfo(info);
					}
				}
				pwInfo.setMsPwInfos(msPwMapper.queryByCondition(mspwinfoCondition));
			}
			this.getOAMandQoSforPw(pwInfoList);
		} catch (Exception e) {
			ExceptionManage.dispose(e,this.getClass());
		}
		return pwInfo;
	}

	public List<PwInfo> findPwByPWIds(List<Integer> pwIdList) throws ParseException {
		List<PwInfo> pwList = this.mapper.findPwByIds(pwIdList);
		if(pwList != null && pwList.size() > 0){
			for (PwInfo pwInfo : pwList) {
				pwInfo.setCreateTime(DateUtil.strDate(pwInfo.getCreateTime(), DateUtil.FULLTIME));
				pwInfo.setType(EPwType.forms(pwInfo.getType_db()));
			}
		}
		return pwList;
	}

	public List<PwInfo> selectPwInfoByTunnelId(List<Integer> tunnelIds) {
		List<PwInfo> pwList = null;
		try {
			pwList = this.mapper.queryByPwTunnelIdCondition(tunnelIds);
			if(pwList != null && pwList.size() > 0){
				for (PwInfo pwinfo : pwList) {
					pwinfo.setType(EPwType.forms(pwinfo.getType_db()));
					pwinfo.setCreateTime(DateUtil.strDate(pwinfo.getCreateTime(), DateUtil.FULLTIME));
				}
			}
			this.getOAMandQoSforPw(pwList);
		} catch (Exception e) {
			ExceptionManage.dispose(e,this.getClass());
		}
		return pwList;
	}

	/**
	 * 查询单网元下的pw
	 * @param siteId
	 * @return
	 * @throws Exception
	 */
	public List<PwInfo> selectNodeBySiteid(int siteId) {
		List<PwInfo> pwInfoList = null;
		List<PwInfo> pwInfoList_result = null;
		PwNniInfo pwNniInfo = null;
		List<PwNniInfo> infos = null;
		PwInfo pwinfoSel = new PwInfo();
		try {
			PwNniInfoMapper pwNniMapper = this.sqlSession.getMapper(PwNniInfoMapper.class);
			MsPwInfoMapper msPwMapper = this.sqlSession.getMapper(MsPwInfoMapper.class);
			pwinfoSel.setASiteId(siteId);
			pwinfoSel.setZSiteId(siteId);
			pwInfoList_result = new ArrayList<PwInfo>();
			if(pwinfoSel != null && pwinfoSel.getType() != null){
				pwinfoSel.setType_db(pwinfoSel.getType().getValue());
			}
			pwInfoList = this.mapper.queryNode(pwinfoSel);
			for (PwInfo pwinfo : pwInfoList) {
				pwinfo.setType(EPwType.forms(pwinfo.getType_db()));
				pwinfo.setCreateTime(DateUtil.strDate(pwinfo.getCreateTime(), DateUtil.FULLTIME));
				pwinfo.setNode(true);
				if (pwinfo.getIsSingle() == 1) {
					if (pwinfo.getASiteId() == siteId && pwinfo.getApwServiceId() != 0) {
						pwInfoList_result.add(pwinfo);
					} else if (pwinfo.getZSiteId() == siteId && pwinfo.getZpwServiceId() != 0) {
						pwInfoList_result.add(pwinfo);
					}
				} else {
					pwInfoList_result.add(pwinfo);
				}
			}
			for (PwInfo pwInfo : pwInfoList_result) {// 封装对应的pwnniInfo
				pwNniInfo = new PwNniInfo();
				pwNniInfo.setPwId(pwInfo.getPwId());
				infos = pwNniMapper.queryByCondition(pwNniInfo);
				MsPwInfo mspwinfoCondition = new MsPwInfo();
				mspwinfoCondition.setPwId(pwInfo.getPwId());
				for (PwNniInfo info : infos) {
					if (info.getSiteId() == pwInfo.getASiteId() && pwInfo.getApwServiceId() != 0) {
						pwInfo.setaPwNniInfo(info);
					}
					if (info.getSiteId() == pwInfo.getZSiteId() && pwInfo.getZpwServiceId() != 0) {
						pwInfo.setzPwNniInfo(info);
					}
				}
				
				pwInfo.setMsPwInfos(msPwMapper.queryByCondition(mspwinfoCondition));
			}
			
			getOAMandQoSforPw(pwInfoList);

		} catch (Exception e) {
			ExceptionManage.dispose(e,this.getClass());
		}
		return pwInfoList_result;
	}

	/**
	 * 搜索pw
	 * @param pwList
	 * @param mapMspwInfo
	 * @throws SQLException 
	 */
	public void doSearch(List<PwInfo> pwList, Map<Integer,List<MsPwInfo>> mapMspwInfo) throws SQLException {
		int newPwId = 0;
		String newPwName = "pw_" + System.currentTimeMillis();
		try {
			this.sqlSession.getConnection().setAutoCommit(true);
			List<Integer> pwIdList = new ArrayList<Integer>();
			for (PwInfo pw : pwList) {
				pwIdList.add(pw.getPwId());
			}
			Map<String, Object> conditionMap = new HashMap<String, Object>();
			conditionMap.put("newPwId", newPwId);
			conditionMap.put("pwIdList", pwIdList);
			newPwId = this.mapper.doSearch(newPwName, pwList.get(0).getPwId(), pwList.get(pwList.size()-1).getPwId());
			//更新业务
			this.mapper.updateServiceByPwId(conditionMap);
			//更新pwnnibuffer关联表
			this.mapper.updatePwBuffByPwId(conditionMap);
			// 更新qos关联表
			this.mapper.updateQosRelevanceByPwId(conditionMap);
			// 更新oam表
			this.mapper.updateOamMepByPwId(conditionMap);
			//更新告警
			this.mapper.updateCurrAlarmByPwId(conditionMap);
			this.mapper.updateHisAlarmByPwId(conditionMap);
			//更新性能
			this.mapper.updatePerformanceByPwId(conditionMap);
			// 删除刚才建立双边数据所用的单边数据
			this.mapper.deleteByPwIdList(pwIdList);
			this.sqlSession.getConnection().setAutoCommit(false);
		} catch (Exception e) {
			ExceptionManage.dispose(e, this.getClass());
		}
	}

	/**
	 * 通过pw过滤条件查询单网元的pw
	 * @param siteId 单网元的id
	 * @param pwFilterCondition pw的过滤条件
	 * @return
	 */
	public List<PwInfo> selectNodeByCondition(PwInfo pwFilterCondition) {
		List<PwInfo> pwInfoList1 = null;
		List<PwInfo> pwInfoList2 = new ArrayList<PwInfo>();
		List<PwInfo> pwInfoList = null;
		List<PwInfo> pwInfoList_result = null;
		PwNniInfo pwNniInfo = null;
		List<PwNniInfo> infos = null;
		List<Tunnel> tunnels = null;
		List<Integer> tunnelIds = null;
		try {
			PwNniInfoMapper pwNniMapper = this.sqlSession.getMapper(PwNniInfoMapper.class);
			TunnelMapper tunnelMapper = this.sqlSession.getMapper(TunnelMapper.class);
			tunnelIds = new ArrayList<Integer>();
			pwInfoList = new ArrayList<PwInfo>();
			pwInfoList_result = new ArrayList<PwInfo>();
			if(pwFilterCondition != null){
				pwFilterCondition.setType_db(pwFilterCondition.getType().getValue());
			}
			pwInfoList1 = this.mapper.queryNode(pwFilterCondition);
			if(pwInfoList1 != null && pwInfoList1.size() > 0){
				for (PwInfo pwInfo : pwInfoList1) {
					pwInfo.setCreateTime(DateUtil.strDate(pwInfo.getCreateTime(), DateUtil.FULLTIME));
					pwInfo.setType(EPwType.forms(pwInfo.getType_db()));
				}
			}
			if(pwFilterCondition.getPortId() > 0)
			{
				//先通过端口号查tunnel，再通过tunnel查pw，然后过滤pw
				tunnels = tunnelMapper.queryByportId(pwFilterCondition.getPortId());
				for(Tunnel tunnel:tunnels)
				{
					tunnelIds.add(tunnel.getTunnelId());
				}
				if(!tunnelIds.isEmpty()){
					pwInfoList2 = this.mapper.queryByPwTunnelIdCondition(tunnelIds);
				}
				for(PwInfo pw1 : pwInfoList1)
				{
					for(PwInfo pw2 : pwInfoList2)
					{
						if(pw2.getPwId() == pw1.getPwId())
						{
							pwInfoList.add(pw1);
						}
					}
				}
			}
			else
			{
				pwInfoList.addAll(pwInfoList1);
			}
			
			for (PwInfo pwinfo : pwInfoList) {
				pwinfo.setNode(true);
				if (pwinfo.getIsSingle() == 1) {
					if (pwinfo.getASiteId() == pwFilterCondition.getASiteId() && pwinfo.getApwServiceId() != 0) {
						pwInfoList_result.add(pwinfo);
					} else if (pwinfo.getZSiteId() == pwFilterCondition.getZSiteId() && pwinfo.getZpwServiceId() != 0) {
						pwInfoList_result.add(pwinfo);
					}
				} else {
					pwInfoList_result.add(pwinfo);
				}
			}
			for (PwInfo pwInfo : pwInfoList_result) {// 封装对应的pwnniInfo
				pwNniInfo = new PwNniInfo();
				pwNniInfo.setPwId(pwInfo.getPwId());
				infos = pwNniMapper.queryByCondition(pwNniInfo);
				for (PwNniInfo info : infos) {
					if (info.getSiteId() == pwInfo.getASiteId() && pwInfo.getApwServiceId() != 0) {
						pwInfo.setaPwNniInfo(info);
					}
					if (info.getSiteId() == pwInfo.getZSiteId() && pwInfo.getZpwServiceId() != 0) {
						pwInfo.setzPwNniInfo(info);
					}
				}
			}
			this.getOAMandQoSforPw(pwInfoList);
		} catch (Exception e) {
			ExceptionManage.dispose(e, this.getClass());
		}
		return pwInfoList_result;
	}

	/**
	 * 创建或修改时，验证此PW承载的tunnel的qos带宽是否可以承载此pw的qos
	 * @param pwInfo  要创建或修改的pw对象
	 * @param qosInfo  qos带宽
	 * @return true 可以承载 false 不可承载
	 * @throws Exception
	 */
	public boolean checkingQos(PwInfo pwInfo, List<QosInfo> qosInfoList, List<QosInfo> update_before_qosInfoList) {
		TunnelService_MB tunnelService = null;
		Tunnel tunnel = null;
		QosInfoService_MB qosInfoService = null;
		QosInfo qosinfo_pw = null;
		boolean flag = true;
		List<Tunnel> tunnelList = null;
		QosInfo qosInfo_pw_before = null;
		int before_cir = 0;
		int before_eir = 0;
		try {
			qosInfoService = (QosInfoService_MB) ConstantUtil.serviceFactory.newService_MB(Services.QosInfo);
			// 根据tunnel主键 查询tunnel对象
			tunnelService = (TunnelService_MB) ConstantUtil.serviceFactory.newService_MB(Services.Tunnel);
			tunnel = new Tunnel();
			tunnel.setTunnelId(pwInfo.getTunnelId());
			tunnelList = tunnelService.selectNodeByTunnelId(tunnel);
			if (null != tunnelList && tunnelList.size() == 1) {
				tunnel = tunnelList.get(0);
			} else {
				throw new Exception("查询tunnel出错");
			}

			for (QosInfo qosInfo_tunnel : tunnel.getQosList()) {
				// 从qos集合中取出来qosui的对象
				qosinfo_pw = qosInfoService.getQosInfo(qosInfoList, qosInfo_tunnel.getCos(), qosInfo_tunnel.getDirection());
				// 如果没查询到 直接返回
				if (qosinfo_pw == null) {
					flag = false;
					break;
				} else {
					if(null!=update_before_qosInfoList){
						qosInfo_pw_before = qosInfoService.getQosInfo(update_before_qosInfoList, qosInfo_tunnel.getCos(), qosInfo_tunnel.getDirection());
						if (null != qosInfo_pw_before) {
							before_cir = qosInfo_pw_before.getCir();
							before_eir = qosInfo_pw_before.getEir();
						}
					}

					QosInfo qosInfo_result=qosInfoService.calculateQos(qosInfo_tunnel, EServiceType.TUNNEL, pwInfo.getTunnelId());
					if (qosInfo_result.getCir() + before_cir < qosinfo_pw.getCir() || qosInfo_result.getEir() + before_eir < qosinfo_pw.getEir()) {
						flag = false;
						break;
					}
				}
			}

		} catch (Exception e) {
			ExceptionManage.dispose(e, this.getClass());
		}
		return flag;
	}

	public List<PwInfo> selectSamePortByTunnelId(int tunnelId, int siteId) {
		List<PwInfo> pwInfoList = null;
		try {
			pwInfoList = this.mapper.selectSamePortByTunnelId(tunnelId,siteId);
			if(pwInfoList != null && pwInfoList.size() > 0){
				for (PwInfo pwInfo : pwInfoList) {
					pwInfo.setCreateTime(DateUtil.strDate(pwInfo.getCreateTime(), DateUtil.FULLTIME));
					pwInfo.setType(EPwType.forms(pwInfo.getType_db()));
				}
			}
		} catch (Exception e) {
			ExceptionManage.dispose(e, this.getClass());
		}
		return pwInfoList;
	}

	public List<PwInfo> select_synchro(int siteid, int pwServiceId, int pwtype) throws ParseException {
		List<PwInfo> pwInfoList = this.mapper.query_synchro(siteid, pwServiceId, pwtype);
		if(pwInfoList != null && pwInfoList.size() > 0){
			for (PwInfo pwInfo : pwInfoList) {
				pwInfo.setCreateTime(DateUtil.strDate(pwInfo.getCreateTime(), DateUtil.FULLTIME));
				pwInfo.setType(EPwType.forms(pwInfo.getType_db()));
			}
		}
		MsPwInfoMapper msPwMapper = this.sqlSession.getMapper(MsPwInfoMapper.class);
		for(PwInfo pwInfo :pwInfoList){
			MsPwInfo mspwinfoCondition = new MsPwInfo();
			mspwinfoCondition.setPwId(pwInfo.getPwId());
			pwInfo.setMsPwInfos(msPwMapper.queryByCondition(mspwinfoCondition));
		}
		return pwInfoList;
	}

	public int save(PwInfo pwinfo) throws Exception {
		if (pwinfo == null) {
			throw new Exception("pwinfo is null");
		}
		int pwId = 0;
		Businessid aServiceId = null;
		Businessid zServiceId = null;
//		QosInfoService qosInfoService = null;
		OamInfoService_MB oamInfoService = null;
		// TunnelService tunnelService = null;
		// Tunnel tunnel = null;
		PwNniInfo aPwnniInfo = null;
		PwNniInfo zPwNniInfo = null;
		QosRelevanceService_MB qosRelevanceService = null;
		List<QosRelevance> qosRelevanceList = null;
		SiteService_MB siteService = null;
		try {
			siteService = (SiteService_MB) ConstantUtil.serviceFactory.newService_MB(Services.SITE, this.sqlSession);
			BusinessidMapper businessidMapper = this.sqlSession.getMapper(BusinessidMapper.class);
//			qosInfoService = (QosInfoService) ConstantUtil.serviceFactory.newService(Services.QosInfo, this.connection);
			oamInfoService = (OamInfoService_MB) ConstantUtil.serviceFactory.newService_MB(Services.OamInfo, this.sqlSession);
			PwNniInfoMapper pwNniMapper = this.sqlSession.getMapper(PwNniInfoMapper.class);
			MsPwInfoMapper msPwMapper = this.sqlSession.getMapper(MsPwInfoMapper.class);
			// 给A和Z端从ID管理表分配设备ID
			if (pwinfo.getIsSingle() == 0) {
					if (pwinfo.getApwServiceId() == 0 ) {
						aServiceId = businessidMapper.queryList(pwinfo.getASiteId(), this.getPwType(pwinfo, "a", pwinfo.getASiteId())).get(0);
					} else {
						aServiceId = businessidMapper.queryByIdValue_SiteId_type(pwinfo.getApwServiceId(), pwinfo.getASiteId(), this.getPwType(pwinfo, "a", pwinfo.getASiteId()));
					}
					if (aServiceId == null) {
						throw new BusinessIdException(siteService.getSiteName(pwinfo.getASiteId())+ResourceUtil.srcStr(StringKeysTip.TIP_PWID));
					}
					pwinfo.setApwServiceId(aServiceId.getIdValue());
					Businessid bCondition = new Businessid();
					bCondition.setId(aServiceId.getId());
					bCondition.setIdStatus(1);
					businessidMapper.update(bCondition);
				
					if (pwinfo.getZpwServiceId() == 0 ) {
						zServiceId = businessidMapper.queryList(pwinfo.getZSiteId(), this.getPwType(pwinfo, "z", pwinfo.getZSiteId())).get(0);
					} else {
						zServiceId = businessidMapper.queryByIdValue_SiteId_type(pwinfo.getZpwServiceId(), pwinfo.getZSiteId(), this.getPwType(pwinfo, "z", pwinfo.getZSiteId()));
					}
					if (zServiceId == null) {
						throw new BusinessIdException(siteService.getSiteName(pwinfo.getZSiteId())+ResourceUtil.srcStr(StringKeysTip.TIP_PWID));
					}
					pwinfo.setZpwServiceId(zServiceId.getIdValue());
					bCondition.setId(zServiceId.getId());
					bCondition.setIdStatus(1);
					businessidMapper.update(bCondition);
				
			} else {
				if (pwinfo.getASiteId() > 0) {
					if (pwinfo.getApwServiceId() == 0) {
						aServiceId = businessidMapper.queryList(pwinfo.getASiteId(), this.getPwType(pwinfo, "a", pwinfo.getASiteId())).get(0);
					} else {
						aServiceId = businessidMapper.queryByIdValue_SiteId_type(pwinfo.getApwServiceId(), pwinfo.getASiteId(), this.getPwType(pwinfo, "a", pwinfo.getASiteId()));
					}
					if (aServiceId == null) {
						throw new BusinessIdException(siteService.getSiteName(pwinfo.getASiteId())+ResourceUtil.srcStr(StringKeysTip.TIP_PWID));
					}
					pwinfo.setApwServiceId(aServiceId.getIdValue());
					Businessid bCondition = new Businessid();
					bCondition.setId(aServiceId.getId());
					bCondition.setIdStatus(1);
					businessidMapper.update(bCondition);
				} else if(pwinfo.getZSiteId() > 0) {
					if (pwinfo.getZpwServiceId() == 0) {
						zServiceId = businessidMapper.queryList(pwinfo.getZSiteId(), this.getPwType(pwinfo, "z", pwinfo.getZSiteId())).get(0);
					} else {
						zServiceId = businessidMapper.queryByIdValue_SiteId_type(pwinfo.getZpwServiceId(), pwinfo.getZSiteId(), this.getPwType(pwinfo, "z", pwinfo.getZSiteId()));
					}
					if (zServiceId == null) {
						throw new BusinessIdException(siteService.getSiteName(pwinfo.getZSiteId())+ResourceUtil.srcStr(StringKeysTip.TIP_PWID));
					}
					pwinfo.setZpwServiceId(zServiceId.getIdValue());
					Businessid bCondition = new Businessid();
					bCondition.setId(zServiceId.getId());
					bCondition.setIdStatus(1);
					businessidMapper.update(bCondition);
				}
			}
			// 获取标签
			this.getLabel(pwinfo);
			pwinfo.setType_db(pwinfo.getType().getValue());
			pwId = this.mapper.insert(pwinfo);
			pwinfo.setPwId(pwId);

			if (pwinfo.getApwServiceId() > 0) {
				aPwnniInfo = this.getPwNniInfo(pwId, pwinfo.getASiteId(), pwinfo.getApwServiceId());
				pwNniMapper.insert(aPwnniInfo);
			}
			if (pwinfo.getZpwServiceId() > 0) {
				zPwNniInfo = this.getPwNniInfo(pwId, pwinfo.getZSiteId(), pwinfo.getZpwServiceId());
				pwNniMapper.insert(zPwNniInfo);
			}

			List<OamInfo> oamList = pwinfo.getOamList();
			if (oamList != null && oamList.size() > 0) {
				for (OamInfo oamInfo : oamList) {
					if (oamInfo.getOamType() == OamTypeEnum.AMEP) {
						oamInfo.getOamMep().setServiceId(pwId);
						oamInfo.getOamMep().setObjId(aServiceId.getIdValue());
						oamInfo.setOamType(OamTypeEnum.AMEP);
					} else if (oamInfo.getOamType() == OamTypeEnum.ZMEP) {
						oamInfo.getOamMep().setServiceId(pwId);
						oamInfo.getOamMep().setObjId(zServiceId.getIdValue());
						oamInfo.setOamType(OamTypeEnum.ZMEP);
					} else if (oamInfo.getOamType() == OamTypeEnum.MEP) {
						oamInfo.getOamMep().setServiceId(pwId);
						oamInfo.getOamMep().setObjId(ConstantUtil.siteId);
						oamInfo.setOamType(OamTypeEnum.MEP);
					} else if (oamInfo.getOamType() == OamTypeEnum.MIP) {

					}
					oamInfoService.saveOrUpdate(oamInfo);
				}
			}
			if(pwinfo.getMsPwInfos() != null){
				for(MsPwInfo msPwInfo: pwinfo.getMsPwInfos()){
					msPwInfo.setPwId(pwId);
					msPwMapper.insert(msPwInfo);
				}
			}
			
			// List<QosInfo> qosList = pwinfo.getQosList();
			// if (qosList != null && qosList.size() > 0) {
			// for (int i = 0; i < qosList.size(); i++) {
			// qosList.get(i).setObjId(pwId);
			// if (null == qosList.get(i).getQosname() || "".equals(qosList.get(i).getQosname())) {
			// qosList.get(i).setQosname(qosList.get(i).getQosType().toLowerCase() + "pw" + pwId);
			// }
			// }
			// qosInfoService.saveOrUpdate(qosList);
			// }

			qosRelevanceService = (QosRelevanceService_MB) ConstantUtil.serviceFactory.newService_MB(Services.QOSRELEVANCE);
			qosRelevanceList = qosRelevanceService.getList(pwinfo);
			if(qosRelevanceList != null && qosRelevanceList.size() >0)
			{
				qosRelevanceService.save(qosRelevanceList);
			}

			//离线网元数据下载
			if(0!=pwinfo.getASiteId()){
				super.dateDownLoad(pwinfo.getASiteId(),pwinfo.getPwId(), EServiceType.PW.getValue(), EActionType.INSERT.getValue());
			}
			if(0!=pwinfo.getZSiteId()){
				super.dateDownLoad(pwinfo.getZSiteId(),pwinfo.getPwId(), EServiceType.PW.getValue(), EActionType.INSERT.getValue());
			}
		} catch (Exception e) {
			ExceptionManage.dispose(e,this.getClass());
		}
		return pwId;
	}

	private PwNniInfo getPwNniInfo(int pwId, int siteId, int pwBusinessId) throws Exception {
		PwNniInfo pwNniInfo = new PwNniInfo();
		pwNniInfo.setPwId(pwId);
		pwNniInfo.setSiteId(siteId);
		pwNniInfo.setPwBusinessId(pwBusinessId);
		SiteService_MB siteService=(SiteService_MB) ConstantUtil.serviceFactory.newService_MB(Services.SITE, this.sqlSession);
		/**
		 * 添加陈晓默认 vlan
		 */
		if (siteService.getManufacturer(siteId) == EManufacturer.CHENXIAO.getValue()) {
			pwNniInfo.setExitRule(UiUtil.getCodeByValue("exitRule", "0").getId());
			pwNniInfo.setSvlan("1");
		}
		// 武汉
		else {
			pwNniInfo.setExitRule(UiUtil.getCodeByValue("PORTTAGBEHAVIOR", "0").getId());
			pwNniInfo.setSvlan("2");
		}

		pwNniInfo.setVlanpri("0");
		pwNniInfo.setTpid(UiUtil.getCodeByValue("LAGVLANTPID", "1").getId());
		pwNniInfo.setHorizontalDivision(UiUtil.getCodeByValue("VCTRAFFICPOLICING", "1").getId());
		pwNniInfo.setMacAddressLearn(UiUtil.getCodeByValue("MACLEARN", "1").getId());
		pwNniInfo.setTagAction(UiUtil.getCodeByValue("TAGRECOGNITION", "0").getId());
		pwNniInfo.setControlEnable(UiUtil.getCodeByValue("ENABLEDSTATUE", "1").getId());
		return pwNniInfo;
	}

	private void getLabel(PwInfo pwInfo) throws Exception {
		if (null == pwInfo) {
			throw new Exception("pwInfo is null");
		}
		LabelInfoService_MB labelInfoService = null;
		SiteService_MB siteService = null;
		try {
			int manufacturerA = 0;
			int manufacturerZ = 0;
			int manufacturer = 0;
			int aLabel = 0;
			int zLabel = 0;
			this.sqlSession.getConnection().setAutoCommit(true);
			LabelInfoMapper labelInfoMapper = this.sqlSession.getMapper(LabelInfoMapper.class);
		    labelInfoService = (LabelInfoService_MB) ConstantUtil.serviceFactory.newService_MB(Services.LABELINFO, this.sqlSession);
			siteService = (SiteService_MB) ConstantUtil.serviceFactory.newService_MB(Services.SITE, this.sqlSession);
			// 等于1是晨晓设备,入标签网元唯一
			manufacturerA = siteService.getManufacturer(pwInfo.getASiteId());
			manufacturerZ = siteService.getManufacturer(pwInfo.getZSiteId());
			//判断isSingle，为0，则代表网络侧，为1，则代表单网元
			if(pwInfo.getIsSingle() == 0){
				if (pwInfo.getInlabelValue() == 0) {
					//普通类型的PW
					if("0".equals(pwInfo.getBusinessType())){
						// 没有填写标签值说明是eline快速配置或者是批量创建普通PW，自动分配标签
						aLabel = this.matchLabel(pwInfo, labelInfoMapper, manufacturerA, manufacturerZ);
						this.updateLabelStatus(labelInfoMapper, aLabel, pwInfo.getASiteId(), manufacturerA);
						pwInfo.setInlabelValue(aLabel);
						zLabel = this.matchLabel(pwInfo, labelInfoMapper, manufacturerA, manufacturerZ);
						this.updateLabelStatus(labelInfoMapper, zLabel, pwInfo.getZSiteId(), manufacturerZ);
						pwInfo.setOutlabelValue(zLabel);
					}else{
						//批量创建多段pw时分配标签
						List<MsPwInfo> msPwList = pwInfo.getMsPwInfos();
						for (int i = 0; i < msPwList.size()+1; i++) {
							PwInfo pwTmp = new PwInfo();
							int aSiteId = 0;
							int zSiteId = 0;
							if(i == 0){
								aSiteId = pwInfo.getASiteId();
								zSiteId = msPwList.get(i).getSiteId();
							}else if(i == msPwList.size()){
								aSiteId = msPwList.get(i-1).getSiteId();
								zSiteId = pwInfo.getZSiteId();
							}else{
								aSiteId = msPwList.get(i-1).getSiteId();
								zSiteId = msPwList.get(i).getSiteId();
							}
							manufacturerA = siteService.getManufacturer(aSiteId);
							manufacturerZ = siteService.getManufacturer(zSiteId);
							pwTmp.setASiteId(aSiteId);
							pwTmp.setZSiteId(zSiteId);
							//a端标签
							aLabel = this.matchLabel(pwTmp, labelInfoMapper, manufacturerA, manufacturerZ);
							if(i == 0){
								this.updateLabelStatus(labelInfoMapper, aLabel, zSiteId, manufacturerZ);
								pwInfo.setInlabelValue(aLabel);
								msPwList.get(i).setFrontInlabel(aLabel);
							}else if(i == msPwList.size()){
								this.updateLabelStatus(labelInfoMapper, aLabel, aSiteId, manufacturerA);
								msPwList.get(i-1).setBackInlabel(aLabel);
								pwInfo.setBackInlabel(aLabel);
							}else{
								this.updateLabelStatus(labelInfoMapper, aLabel, aSiteId, manufacturerA);
								msPwList.get(i-1).setBackInlabel(aLabel);
								msPwList.get(i).setFrontInlabel(aLabel);
							}
							//z端标签
							zLabel = this.matchLabel(pwTmp, labelInfoMapper, manufacturerA, manufacturerZ);
							if(i == 0){
								this.updateLabelStatus(labelInfoMapper, zLabel, aSiteId, manufacturerA);
								pwInfo.setOutlabelValue(zLabel);
								msPwList.get(i).setBackOutlabel(zLabel);
							}else if(i == msPwList.size()){
								this.updateLabelStatus(labelInfoMapper, aLabel, zSiteId, manufacturerZ);
								msPwList.get(i-1).setFrontOutlabel(zLabel);
								pwInfo.setBackOutlabel(zLabel);
							}else{
								this.updateLabelStatus(labelInfoMapper, aLabel, zSiteId, manufacturerZ);
								msPwList.get(i-1).setFrontOutlabel(zLabel);
								msPwList.get(i).setBackOutlabel(zLabel);
							}
						}
					}
				} else {
					if("1".equals(pwInfo.getBusinessType())){
						LabelInfo labelCondition = new LabelInfo();
						labelCondition.setLabelValue(pwInfo.getOutlabelValue());
						labelCondition.setSiteid(pwInfo.getASiteId());
						labelCondition.setType(manufacturerA == 1 ? "CX" : "PW");
						labelInfoMapper.insertNewLabel(labelCondition);
						labelCondition.setLabelStatus(0);
						labelInfoMapper.updateBatch(labelCondition);
						for(MsPwInfo msPwInfo : pwInfo.getMsPwInfos()){
							manufacturer = siteService.getManufacturer(msPwInfo.getSiteId());
							labelCondition.setLabelValue(msPwInfo.getFrontInlabel());
							labelCondition.setSiteid(msPwInfo.getSiteId());
							labelCondition.setType(manufacturer == 1 ? "CX" : "PW");
							labelInfoMapper.insertNewLabel(labelCondition);
							labelInfoMapper.updateBatch(labelCondition);
							labelCondition.setLabelValue(msPwInfo.getBackInlabel());
							labelInfoMapper.insertNewLabel(labelCondition);
							labelInfoMapper.updateBatch(labelCondition);
						}
						labelCondition.setLabelValue(pwInfo.getBackInlabel());
						labelCondition.setSiteid(pwInfo.getZSiteId());
						labelCondition.setType(manufacturerZ == 1 ? "CX" : "PW");
						labelInfoMapper.insertNewLabel(labelCondition);
						labelInfoMapper.updateBatch(labelCondition);
					}else{
						LabelInfo labelCondition = new LabelInfo();
						labelCondition.setLabelValue(pwInfo.getInlabelValue());
						labelCondition.setSiteid(pwInfo.getASiteId());
						labelCondition.setType(manufacturerA == 1 ? "CX" : "PW");
						labelCondition.setLabelStatus(0);
						labelInfoMapper.insertNewLabel(labelCondition);
						labelInfoMapper.updateBatch(labelCondition);
						labelCondition.setLabelValue(pwInfo.getOutlabelValue());
						labelCondition.setSiteid(pwInfo.getZSiteId());
						labelCondition.setType(manufacturerZ == 1 ? "CX" : "PW");
						labelInfoMapper.insertNewLabel(labelCondition);
						labelInfoMapper.updateBatch(labelCondition);
					}
				}
			}else{
				// 填写了标签，说明是单网元配置，直接修改标签状态
//				labelInfoService.saveOrUpdate(pwInfo.getInlabelValue(), ConstantUtil.siteId, 0, connection);
				if(pwInfo.getZSiteId() > 0){
					labelInfoService.saveOrUpdate(pwInfo.getOutlabelValue(), pwInfo.getZSiteId(), 0, manufacturerZ == 1 ? "CX" : "PW");
				}else if(pwInfo.getASiteId() > 0){
					labelInfoService.saveOrUpdate(pwInfo.getInlabelValue(), pwInfo.getASiteId(), 0,manufacturerA == 1 ? "CX" : "PW");
				}
				if(pwInfo.getMsPwInfos() != null && pwInfo.getMsPwInfos().size() >0){
					
					for(MsPwInfo msPwInfo : pwInfo.getMsPwInfos()){
						manufacturer = siteService.getManufacturer(msPwInfo.getSiteId());
						LabelInfo labelCondition = new LabelInfo();
						labelCondition.setLabelValue(msPwInfo.getFrontInlabel());
						labelCondition.setSiteid(msPwInfo.getSiteId());
						labelCondition.setType(manufacturer == 1 ? "CX" : "PW");
						labelCondition.setLabelStatus(0);
						labelInfoMapper.insertNewLabel(labelCondition);
						labelInfoMapper.updateBatch(labelCondition);
						labelCondition.setLabelValue(msPwInfo.getBackInlabel());
						labelInfoMapper.insertNewLabel(labelCondition);
						labelInfoMapper.updateBatch(labelCondition);
					}
				}
			}
		} catch (Exception e) {
			ExceptionManage.dispose(e,this.getClass());
		} finally {
			this.sqlSession.getConnection().setAutoCommit(true);
		}
	}
	
	private int matchLabel(PwInfo pwInfo, LabelInfoMapper labelInfoMapper, int manufacturerA, int manufacturerZ) throws Exception {
		int label = 0;
		Map<String, Object> map = new HashMap<String, Object>();
		//目前设备的芯片不支持同一端口的lsp的入标签和该端口上的pw的入标签一样,所以要用下面的代码
		String type = "PW";
		if(type.equals("TUNNEL") || type.equals("PW")){
			type = "WH";
		}
		//如果以后芯片支持同一端口的lsp的入标签和该端口上的pw的入标签一样,就用下面的代码,把上面的代码关掉
		map.put("aSiteId", pwInfo.getASiteId());
		map.put("zSiteId", pwInfo.getZSiteId());
		map.put("condition", new ArrayList<Integer>());
		map.put("type", type);
		map.put("manufacturerA", manufacturerA);
		map.put("manufacturerZ", manufacturerZ);
		List<Integer> labelList = labelInfoMapper.queryLabelListBySite(map);
		if (labelList.size() == 0) {
			label = this.initLabel(pwInfo.getASiteId(), pwInfo.getZSiteId(), labelInfoMapper, manufacturerA, manufacturerZ);
		}else{
			label = labelList.get(0);
		}
		return label;
	}
	
	private void updateLabelStatus(LabelInfoMapper labelInfoMapper, int label, int siteId, int manufacturer) throws Exception{
		LabelInfo labelCondition = new LabelInfo();
		labelCondition.setLabelValue(label);
		labelCondition.setSiteid(siteId);
		labelCondition.setType(manufacturer == 1 ? "CX" : "PW");
		labelCondition.setLabelStatus(0);
		labelInfoMapper.updateBatch(labelCondition);
	}

	/**
	 * 初始化标签
	 */
	private int initLabel(int aSiteId, int zSiteId, LabelInfoMapper labelInfoMapper, int manufacturerA, int manufacturerZ) throws Exception {
		try {
			Map<String, Object> map = new HashMap<String, Object>();
			//目前设备的芯片不支持同一端口的lsp的入标签和该端口上的pw的入标签一样,所以要用下面的代码
			String type = "PW";
			if(type.equals("TUNNEL") || type.equals("PW")){
				type = "WH";
			}
			//如果以后芯片支持同一端口的lsp的入标签和该端口上的pw的入标签一样,就用下面的代码,把上面的代码关掉
			while (true) {
				LabelManage labelManage = new LabelManage();
				labelManage.addLabel(aSiteId, zSiteId, "PW", labelInfoMapper);
				map.put("aSiteId", aSiteId);
				map.put("zSiteId", zSiteId);
				map.put("condition", new ArrayList<Integer>());
				map.put("type", type);
				map.put("manufacturerA", manufacturerA);
				map.put("manufacturerZ", manufacturerZ);
				List<Integer> labelList = labelInfoMapper.queryLabelListBySite(map);
				for (Integer label : labelList) {
					if(label > 0){
						return label;
					}
				}
			}
		} catch (Exception e) {
			throw e;
		}
	}

	private String getPwType(PwInfo pwinfo, String type, int siteId) throws Exception {
		SiteService_MB siteService = (SiteService_MB) ConstantUtil.serviceFactory.newService_MB(Services.SITE, this.sqlSession);
		if (siteService.getManufacturer(siteId) == EManufacturer.valueOf("WUHAN").getValue()) {
			return "ethpw";
		}
		if (pwinfo.getType() == EPwType.PDH_SDH) {
			if ("a".equals(type)) {
				return "pdhpw";
			} else {
				return "sdhpw";
			}
		} else if (pwinfo.getType() == EPwType.SDH_PDH) {
			if ("a".equals(type)) {
				return "sdhpw";
			} else {
				return "pdhpw";
			}
		} else {
			return pwinfo.getType().toString().toLowerCase() + "pw";
		}
	}

	public int update(PwInfo pwinfo) throws Exception {
		if (pwinfo == null) {
			throw new Exception("pwinfo is null");
		}
		int result = 0;
		PwInfo oldPwInfo = null;
		OamInfoService_MB oamInfoService = null;
		QosRelevanceService_MB qosRelevanceService = null;
		LabelInfoService_MB labelService = null;
		try {
			oamInfoService = (OamInfoService_MB) ConstantUtil.serviceFactory.newService_MB(Services.OamInfo, this.sqlSession);
		    labelService = (LabelInfoService_MB) ConstantUtil.serviceFactory.newService_MB(Services.LABELINFO, this.sqlSession);
		    MsPwInfoMapper msPwMapper = this.sqlSession.getMapper(MsPwInfoMapper.class);
			//先释放之前的标签，在更新pw，更新标签
			//释放标签
		    oldPwInfo = new PwInfo();
		    oldPwInfo.setPwId(pwinfo.getPwId());
			oldPwInfo = selectBypwid_notjoin(oldPwInfo);
			if(oldPwInfo.getIsSingle() == 0){
				//修改标签状态，如果是网络侧，修改a，z两端，否则只修改一端
				if("1".equals(oldPwInfo.getBusinessType())){
					labelService.updateBatch(oldPwInfo.getOutlabelValue(), oldPwInfo.getASiteId(), 1, "PW");
					for(MsPwInfo msPwInfo: oldPwInfo.getMsPwInfos()){
						labelService.updateBatch(msPwInfo.getFrontInlabel(), msPwInfo.getSiteId(), 1, "PW");
						labelService.updateBatch(msPwInfo.getBackInlabel(), msPwInfo.getSiteId(), 1, "PW");
					}
					labelService.updateBatch(oldPwInfo.getBackInlabel(), oldPwInfo.getZSiteId(), 1, "PW");
				}else{
					labelService.updateBatch(oldPwInfo.getInlabelValue(), oldPwInfo.getASiteId(), 1, "PW");
					labelService.updateBatch(oldPwInfo.getOutlabelValue(), oldPwInfo.getZSiteId(), 1,"PW");
				}
				
			}else{
				if(oldPwInfo.getASiteId()>0){
					labelService.updateBatch(oldPwInfo.getInlabelValue(), oldPwInfo.getASiteId(), 1, "PW");
				}else if(oldPwInfo.getZSiteId()>0){
					labelService.updateBatch(oldPwInfo.getOutlabelValue(), oldPwInfo.getZSiteId(), 1, "PW");
				}else
				{
					if(oldPwInfo.getMsPwInfos() != null && oldPwInfo.getMsPwInfos().size()> 0)
					{
						for(MsPwInfo msPwInfo: oldPwInfo.getMsPwInfos()){
							labelService.updateBatch(msPwInfo.getFrontInlabel(), msPwInfo.getSiteId(), 1, "PW");
							labelService.updateBatch(msPwInfo.getBackInlabel(), msPwInfo.getSiteId(), 1, "PW");
						}	
					}
				}
			}
			//更新标签
			//将labelInfo中没有的数据插入labelInfo中
			if(pwinfo.getIsSingle() == 0){
				if("1".equals(pwinfo.getBusinessType())){
					labelService.insertNewLabel(pwinfo.getOutlabelValue(), pwinfo.getASiteId(), "PW");
					labelService.updateBatch(pwinfo.getOutlabelValue(), pwinfo.getASiteId(), 0, "PW");
					for(MsPwInfo msPwInfo: pwinfo.getMsPwInfos()){
						labelService.insertNewLabel(msPwInfo.getFrontInlabel(), msPwInfo.getSiteId(), "PW");
						labelService.updateBatch(msPwInfo.getFrontInlabel(), msPwInfo.getSiteId(), 0, "PW");
						labelService.insertNewLabel(msPwInfo.getBackInlabel(), msPwInfo.getSiteId(),"PW");
						labelService.updateBatch(msPwInfo.getBackInlabel(), msPwInfo.getSiteId(), 0, "PW");
					}
					labelService.insertNewLabel(pwinfo.getBackInlabel(), pwinfo.getZSiteId(), "PW");
					labelService.updateBatch(pwinfo.getBackInlabel(), pwinfo.getZSiteId(), 0, "PW");
				}else{
					labelService.insertNewLabel(pwinfo.getInlabelValue(), pwinfo.getASiteId(), "PW");
					labelService.insertNewLabel(pwinfo.getOutlabelValue(), pwinfo.getZSiteId(),"PW");
					// 修改前向标签状态
					labelService.updateBatch(pwinfo.getInlabelValue(), pwinfo.getASiteId(), 0,"PW");
					// 修改后向标签状态
					labelService.updateBatch(pwinfo.getOutlabelValue(), pwinfo.getZSiteId(), 0,"PW");
				}
			}else{
				if(pwinfo.getZSiteId()>0){
					labelService.insertNewLabel(pwinfo.getOutlabelValue(), pwinfo.getZSiteId(), "PW");
					labelService.updateBatch(pwinfo.getOutlabelValue(), pwinfo.getZSiteId(), 0, "PW");
				}else if(pwinfo.getASiteId()>0){
					labelService.insertNewLabel(pwinfo.getInlabelValue(), pwinfo.getASiteId(), "PW");
					labelService.updateBatch(pwinfo.getInlabelValue(), pwinfo.getASiteId(), 0, "PW");
				}else
				{
					if(pwinfo.getMsPwInfos() != null && pwinfo.getMsPwInfos().size()> 0)
					{
						for(MsPwInfo msPwInfo: pwinfo.getMsPwInfos()){
							labelService.insertNewLabel(msPwInfo.getFrontInlabel(), msPwInfo.getSiteId(), "PW");
							labelService.updateBatch(msPwInfo.getFrontInlabel(), msPwInfo.getSiteId(), 0, "PW");
							labelService.insertNewLabel(msPwInfo.getBackInlabel(), msPwInfo.getSiteId(),"PW");
							labelService.updateBatch(msPwInfo.getBackInlabel(), msPwInfo.getSiteId(), 0, "PW");
						}	
					}
					
				}
			}
			pwinfo.setType_db(pwinfo.getType().getValue());
			result = this.mapper.update(pwinfo);

			List<OamInfo> oamList = pwinfo.getOamList();
			if (oamList != null && oamList.size() > 0) {
				for (OamInfo oamInfo : oamList) {
					if (oamInfo.getOamType() == OamTypeEnum.AMEP) {
						oamInfo.getOamMep().setServiceId(pwinfo.getPwId());
						oamInfo.getOamMep().setObjId(pwinfo.getApwServiceId());
						oamInfo.setOamType(OamTypeEnum.AMEP);
					} else if (oamInfo.getOamType() == OamTypeEnum.ZMEP) {
						oamInfo.getOamMep().setServiceId(pwinfo.getPwId());
						oamInfo.getOamMep().setObjId(pwinfo.getZpwServiceId());
						oamInfo.setOamType(OamTypeEnum.ZMEP);
					} else if (oamInfo.getOamType() == OamTypeEnum.MEP) {
						oamInfo.getOamMep().setServiceId(pwinfo.getPwId());
						oamInfo.getOamMep().setObjId(ConstantUtil.siteId);
						oamInfo.setOamType(OamTypeEnum.MEP);
					}
					oamInfoService.saveOrUpdate(oamInfo);
				}
			}

			qosRelevanceService = (QosRelevanceService_MB) ConstantUtil.serviceFactory.newService_MB(Services.QOSRELEVANCE);
			if(null != pwinfo.getQosList() && pwinfo.getQosList().size() > 0){
				qosRelevanceService.synchro(pwinfo.getPwId(), pwinfo.getQosList().get(0), EServiceType.PW.toString());
			}

			//离线网元数据下载
			if(0!=pwinfo.getASiteId()){
				super.dateDownLoad(pwinfo.getASiteId(),pwinfo.getPwId(), EServiceType.PW.getValue(), EActionType.UPDATE.getValue());
			}
			if(0!=pwinfo.getZSiteId()){
				super.dateDownLoad(pwinfo.getZSiteId(),pwinfo.getPwId(), EServiceType.PW.getValue(), EActionType.UPDATE.getValue());
			}
			if(pwinfo.getMsPwInfos() != null){
				for(MsPwInfo msPwInfo : pwinfo.getMsPwInfos()){
					msPwMapper.update(msPwInfo);
				}
			}
			this.sqlSession.commit();
		} catch (Exception e) {
			ExceptionManage.dispose(e,this.getClass());
		}
		return result;
	}
}
