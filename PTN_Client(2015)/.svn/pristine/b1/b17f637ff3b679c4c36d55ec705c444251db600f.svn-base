package com.nms.model.equipment.card;

import java.sql.Connection;
import java.util.ArrayList;
import java.util.List;

import com.nms.db.bean.equipment.card.CardInst;
import com.nms.db.bean.equipment.port.E1Info;
import com.nms.db.bean.equipment.port.Port2LayerAttr;
import com.nms.db.bean.equipment.port.PortAttr;
import com.nms.db.bean.equipment.port.PortInst;
import com.nms.db.bean.equipment.port.PortStm;
import com.nms.db.bean.equipment.port.PortStmTimeslot;
import com.nms.db.bean.equipment.shelf.SiteInst;
import com.nms.db.bean.equipment.slot.SlotInst;
import com.nms.db.dao.equipment.card.CardInstDao;
import com.nms.db.dao.equipment.port.E1Dao;
import com.nms.db.dao.equipment.port.Port2LayerAttrDao;
import com.nms.db.dao.equipment.port.PortAttrDao;
import com.nms.db.dao.equipment.port.PortInstDao;
import com.nms.db.dao.equipment.port.PortStmDao;
import com.nms.db.dao.equipment.port.PortStmTimeslotDao;
import com.nms.db.dao.equipment.shelf.SiteInstDao;
import com.nms.db.dao.equipment.slot.SlotInstDao;
import com.nms.db.enums.EActionType;
import com.nms.db.enums.EJobStatus;
import com.nms.db.enums.EServiceType;
import com.nms.model.equipment.port.PortService;
import com.nms.model.util.ObjectService;
import com.nms.model.util.Services;
import com.nms.ui.manager.ConstantUtil;
import com.nms.ui.manager.ExceptionManage;

public class CardService extends ObjectService {
	public void setConnection(Connection connection) {
		super.connection = connection;
	}

	public void setPtnuser(String ptnuser) {
		super.ptnuser = ptnuser;
	}

	private CardInstDao cardInstDao = new CardInstDao();
	private static final int LAST_MAX = 5;
	private static final int MIDDLE_MAX = 7;

	/**
	 * 新增或修改cardinst对象，通过cardinst.getCard_Inst_Id()来判断是修改还是新增
	 * 
	 * @param cardinst
	 *            实体
	 * @throws Exception
	 */
	public void saveOrUpdate(CardInst cardinst) throws Exception {

		if (cardinst == null) {
			throw new Exception("cardinst is null");
		}

		PortInst portinst = null;
		PortInstDao portinstdao = null;
		List<PortInst> portinstlist = null;
		SlotInst slotInst = null;
		SlotInstDao slotInstDao = null;
		List<SlotInst> slotList = null;
		PortStmDao portStmDao = null;
		PortStmTimeslotDao portStmTimeslotDao = null;
		E1Dao e1Dao = null;
		int legId = 1;
		int cardId = 0;
		SiteInstDao siteDao = null;
		SiteInst site = null;
		List<SiteInst> siteList = null;
		try {
			portStmDao = new PortStmDao();
			portStmTimeslotDao = new PortStmTimeslotDao();
			e1Dao = new E1Dao();
			connection.setAutoCommit(false);
			if (cardinst.getId() == 0) {
				cardId = this.cardInstDao.insert(cardinst, connection);
				portinstlist = cardinst.getPortList();
				portinstdao = new PortInstDao();
				Port2LayerAttrDao port2LayerDao = new Port2LayerAttrDao();
				siteDao = new SiteInstDao();
				site = new SiteInst();
				site.setSite_Inst_Id(cardinst.getSiteId());
				siteList = siteDao.queryByCondition(site, connection);
				if(siteList != null && siteList.size() == 1){
					if(siteList.get(0).getManufacturer() == 0){
						for (int i = 0; i < portinstlist.size(); i++) {
							portinstlist.get(i).setIsEnabledLaser(1);
							if(portinstlist.get(i).getNumber()>0 && !portinstlist.get(i).getPortName().contains("e1")){
								portinstlist.get(i).setIsEnabled_code(1);
							}
						}
					}
				}
				
				for (int i = 0; i < portinstlist.size(); i++) {
					portinst = portinstlist.get(i);
					portinst.setCardId(cardId);
					portinst.setJobStatus(EJobStatus.TSF.getValue()+"");
					int portId = portinstdao.insert(portinst, connection);
					if("NONE".equals(portinst.getPortType())){
						//插入portattr属性
						PortAttr portAttr=new PortAttr();
						portAttr.setPortId(portId);
						portAttr.setSiteId(portinst.getSiteId());
						portAttr.setWorkModel(70);
						portAttr.setFluidControl(27);
						portAttr.getPortUniAttr().setBroadcast(1000000+"");
						portAttr.getPortUniAttr().setIsBroadcast(85);
						portAttr.getPortUniAttr().setMulticast(1000000+"");
						portAttr.getPortUniAttr().setIsMulticast(85);
						portAttr.getPortUniAttr().setUnicast(1000000+"");
						portAttr.getPortUniAttr().setIsUnicast(85);
						portAttr.getPortUniAttr().setVlanRelevance(50);
						portAttr.getPortUniAttr().setEightIpRelevance(50);
						portAttr.getPortUniAttr().setSourceMacRelevance(50);
						portAttr.getPortUniAttr().setDestinationMacRelevance(50);
						portAttr.getPortUniAttr().setSourceIpRelevance(50);
						portAttr.getPortUniAttr().setDestinationIpRelevance(50);
						portAttr.getPortUniAttr().setPwRelevance(50);
						portAttr.getPortUniAttr().setDscpRelevance(50);
						portAttr.getPortUniAttr().setSourceTcpPortRelevance(0);
						portAttr.getPortUniAttr().setEndTcpPortRelevance(0);
						portAttr.getPortUniAttr().setTosRelevance(0);
						PortAttrDao portAttrDao=new PortAttrDao();
						portAttrDao.insert(portAttr, connection);
						
						//插入端口2层属性
						Port2LayerAttr attr = new Port2LayerAttr();
						attr.setSiteId(portinst.getSiteId());
						attr.setPortId(portId);
						attr.setPortNumber(portinst.getNumber());
						attr.setMacEnable(1);
						attr.setMacCount(512);
						attr.setTpIdType(0);
						attr.setVlanCount(0);
						attr.setPortType(1);
						attr.setPvid(1);
						attr.setQinqEnable(0);
						attr.setQinqModel(0);
						attr.setVlans("");
						attr.setQinqs("");
						port2LayerDao.saveOrUpdate(attr, connection);
					}
					
					//插入stm1
					if (portinst.getPortType().equals("STM1")) {
						PortStm portStm = new PortStm();
						portStm.setPortid(portId);
						portStm.setSiteid(portinst.getSiteId());
						int portstmId = portStmDao.insert(portStm, connection);
						int last = 3;
						int middle = 1;
						int front = 1;
						for (int j = 1; j <= 63; j++) {
							PortStmTimeslot portStmTimeslot = new PortStmTimeslot();
							portStmTimeslot.setPortid(portId);
							portStmTimeslot.setPortstmid(portstmId);
							portStmTimeslot.setManagerStatus(0);
							portStmTimeslot.setTimeslotnumber(portinst.getPortName() + "/" + j);
							portStmTimeslot.setSiteId(portinst.getSiteId());

							if (last > LAST_MAX) {
								last = 3;
								middle++;
								if (middle > MIDDLE_MAX) {
									middle = 1;
									front++;
								}
							}

							portStmTimeslot.setTimeslotname("1.0." + front + "." + middle + "." + last);
							portStmTimeslotDao.insert(portStmTimeslot, connection);
							last++;
						}

					} else if (portinst.getPortType().equals("e1")) {
						E1Info e1Info = new E1Info();
						e1Info.setCardId(cardId);
						e1Info.setSiteId(portinst.getSiteId());
						e1Info.setPortId(portId);
						e1Info.setPortName(portinst.getPortName());
						e1Info.setLegId(legId);
						e1Dao.insert(e1Info, connection);
						legId++;
					}
					// if (portinst.getChildPortList() != null && portinst.getChildPortList().size() > 0) {
					// for (PortInst childPort : portinst.getChildPortList()) {
					// childPort.setCardId(cardId);
					// childPort.setParentId(portId);
					// }
					// }
				}

				slotInst = new SlotInst();
				slotInst.setId(cardinst.getSlotId());

				slotInstDao = new SlotInstDao();
				slotList = slotInstDao.queryByCondition(slotInst, connection);

				if (slotList != null && slotList.size() != 0) {
					slotInst = slotList.get(0);
					slotInst.setCardId(cardId);
					slotInstDao.update(slotInst, connection);
				} else {
					throw new Exception("关联SLOT失败");
				}
				
				//离线数据下载
				super.dateDownLoad(cardinst.getSiteId(),cardId,EServiceType.CARD.getValue(),EActionType.INSERT.getValue() ,cardinst.getSlotInst().getNumber()+"",null,0,0,null);
			} else {
				this.cardInstDao.update(cardinst, connection);
				//离线数据下载
				super.dateDownLoad(cardinst.getSiteId(),cardinst.getId(),EServiceType.CARD.getValue(),EActionType.UPDATE.getValue() ,cardinst.getSlotInst().getNumber()+"",null,0,0,null);
			}
			if(!connection.getAutoCommit()){
				connection.commit();
			}
		} catch (Exception e) {
			connection.rollback();
			ExceptionManage.dispose(e,this.getClass());
		} finally {
			connection.setAutoCommit(true);
			portinst = null;
			portinstdao = null;
			portinstlist = null;
			slotInst = null;
			slotInstDao = null;
			slotList = null;
			portStmDao = null;
			e1Dao = null;
			siteDao = null;
			site = null;
			siteList = null;
		}
	}

	/**
	 * 根据主键删除
	 * 
	 * @param id
	 *            主键
	 * @return 删除的记录数
	 * @throws Exception
	 */
	public int delete(int id) throws Exception {

		int result = 0;

		try {
			result = cardInstDao.delete(id, connection);
			
		} catch (Exception e) {
			ExceptionManage.dispose(e,this.getClass());
		}
		return result;

	}

	/**
	 * 删除card port 修改slot的cardID为0
	 * 
	 * @param cardInst
	 *            card对象
	 * @throws Exception
	 */
	public void delete(CardInst cardInst) throws Exception {

		int result = 0;
		PortInstDao portInstDao = null;
		PortInst portInst = null;
		SlotInstDao slotInstDao = null;
		SlotInst slotInst = null;
		E1Dao e1Dao = null;
		E1Info e1Info = new E1Info();
		PortAttrDao portAttrDao = null;
		Port2LayerAttrDao port2LayerDao = null;
		try {
			connection.setAutoCommit(false);

			slotInstDao = new SlotInstDao();
			slotInst = cardInst.getSlotInst();
			slotInst.setCardId(0);
			slotInstDao.update(slotInst, connection);

			portInstDao = new PortInstDao();
			portInst = new PortInst();
			portInst.setCardId(cardInst.getId());
			
			List<PortInst> portInsts = portInstDao.queryByCondition(portInst, connection);
			portAttrDao = new PortAttrDao();
			port2LayerDao = new Port2LayerAttrDao();
			for(PortInst inst : portInsts){
				portAttrDao.deleteByPortId(inst.getPortId(), connection);
				port2LayerDao.deleteByPortId(inst.getPortId(), connection);
			}
			//必须先把port上的属性删掉才能删port
			portInstDao.delete(portInst, connection);
			
			e1Dao = new E1Dao();
			e1Info.setCardId(cardInst.getId());
			e1Dao.delete(e1Info, connection);
			result = this.cardInstDao.delete(cardInst.getId(), connection);
			
			//离线数据下载
			super.dateDownLoad(cardInst.getSiteId(),cardInst.getId(),EServiceType.CARD.getValue(),EActionType.DELETE.getValue() ,slotInst.getNumber()+"",null,0,0,null);

			if(!connection.getAutoCommit()){
				connection.commit();
			}
		} catch (Exception e) {
			connection.rollback();
			ExceptionManage.dispose(e,this.getClass());
		} finally {
			connection.setAutoCommit(true);
			portInstDao = null;
			portInst = null;
			slotInstDao = null;
			slotInst = null;
		}
	}

	/**
	 * 查询全部
	 * 
	 * @return List<CardInst>集合
	 * @throws Exception
	 */
	public List<CardInst> select() throws Exception {
		CardInst cardinst = null;
		List<CardInst> cardinstList = null;
		PortInst portinst = null;
		List<PortInst> portinstList = null;
		PortService portService = null;
		try {
			cardinst = new CardInst();
			cardinstList = cardInstDao.queryByCondition(cardinst, connection);
			portService = (PortService) ConstantUtil.serviceFactory.newService(Services.PORT, this.connection);
			if (null != cardinstList && cardinstList.size() != 0) {
				for (int i = 0; i < cardinstList.size(); i++) {
					portinst = new PortInst();
					portinst.setCardId(cardinstList.get(i).getId());

					portinstList = portService.select(portinst);
					cardinstList.get(i).setPortList(portinstList);
				}
			}
		} catch (Exception e) {
			ExceptionManage.dispose(e,this.getClass());
		} finally {
			cardinst = null;
			portinst = null;
			portinstList = null;
//			UiUtil.closeService(portService);
		}

		return cardinstList;
	}

	/**
	 * 根据条件查询
	 * 
	 * @param cardinst
	 *            查询条件
	 * @return List<CardInst> 集合
	 * @throws Exception
	 */
	public List<CardInst> select(CardInst cardinst) throws Exception {
		List<CardInst> cardinstList = null;
		PortInst portinst = null;
		PortService portService = null;
		List<PortInst> portinstList = null;
		try {
			cardinstList = cardInstDao.queryByCondition(cardinst, connection);
			portService = (PortService) ConstantUtil.serviceFactory.newService(Services.PORT, this.connection);
			if (null != cardinstList && cardinstList.size() != 0) {
				for (int i = 0; i < cardinstList.size(); i++) {
					portinst = new PortInst();
					portinst.setCardId(cardinstList.get(i).getId());

					portinstList = portService.select(portinst);
					cardinstList.get(i).setPortList(portinstList);
				}
			}
		} catch (Exception e) {
			ExceptionManage.dispose(e,this.getClass());
		} finally {
			cardinst = null;
			portinst = null;
//			UiUtil.closeService(portService);
			portinstList = null;
		}

		return cardinstList;
	}

	/**
	 * 根据网元id查询所有板卡，无需关联其他表
	 * @param siteId
	 * @return
	 */
	public List<CardInst> selectBySiteId(int siteId){
		List<CardInst> cardInsts = null;
		CardInst cardinst = new CardInst();
		cardinst.setSiteId(siteId);
		try {
			cardInsts = cardInstDao.queryByCondition(cardinst, connection);
		} catch (Exception e) {
			ExceptionManage.dispose(e, this.getClass());
		}
		return cardInsts;
	}
    
	public List<Integer> select(CardInst cardinst, SiteInst siteInst) throws Exception{
		// TODO Auto-generated method stub
		List<Integer> card=null;
		try {
		card = (List<Integer>) new ArrayList<Integer>();
		card = cardInstDao.querryByType(cardinst.getCardName(),siteInst.getSite_Inst_Id(),connection);	
		} catch (Exception e) {
			ExceptionManage.dispose(e,this.getClass());
		}
		return card;
	}
		
}
