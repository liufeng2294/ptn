package com.nms.model.system;

import java.sql.Connection;
import java.util.ArrayList;
import java.util.List;

import com.nms.db.bean.equipment.shelf.SiteInst;
import com.nms.db.bean.system.Field;
import com.nms.db.bean.system.WorkIps;
import com.nms.db.bean.system.user.UserField;
import com.nms.db.bean.system.user.UserInst;
import com.nms.db.dao.equipment.shelf.SiteInstDao;
import com.nms.db.dao.system.FieldDao;
import com.nms.db.dao.system.SubnetDao;
import com.nms.db.dao.system.WorkIpsDao;
import com.nms.db.dao.system.user.UserFieldDao;
import com.nms.model.util.ObjectService;
import com.nms.ui.manager.ConstantUtil;
import com.nms.ui.manager.ExceptionManage;

public class FieldService extends ObjectService {

	public void setConnection(Connection connection) {
		super.connection = connection;
	}

	public void setPtnuser(String ptnuser) {
		super.ptnuser = ptnuser;
	}

	private final FieldDao fieldDao = new FieldDao();

	/**
	 * 新增或修改field对象，通过field.getId()来判断是修改还是新增
	 * 
	 * @param field
	 *            实体
	 * @return 执行成功的记录数
	 * @throws Exception
	 */
	public int saveOrUpdate(Field field) throws Exception {

		if (field == null) {
			throw new Exception("field is null");
		}
		UserFieldDao userFieldDao=null;
		UserField userField=null;
		UserInst userInst=null;
		int result = 0;
		try {
			userFieldDao=new UserFieldDao();
			if (field.getId() == 0) {
				result = this.fieldDao.insert(field, connection);
				/**
				 * 若此次新建域的操作用户不是系统默认账户（admin）
				 * 	 查看 isAll属性
				 * 		0，添加到用户，域的关联表中，1 不做处理
				 */
				userInst=ConstantUtil.user;
				if(!"admin".equals(userInst.getUser_Name())){
					//已选择  显示 所有域
					if(0==userInst.getIsAll()){
						//向  用户—域关联表中添加数据
						userField=new UserField();
						userField.setUser_id(userInst.getUser_Id());
						userField.setField_id(result);
						userFieldDao.insert(userField, connection);
					}
				}
				
					
			} else {
				result = this.fieldDao.update(field, connection);
			}

		} catch (Exception e) {
			ExceptionManage.dispose(e,this.getClass());
		}finally{			
			userFieldDao=null;
			 userField=null;
			 userInst=null;
		}
		return result;
	}

	/**
	 * 通过主键删除file对象
	 * 
	 * @param id
	 *            主键
	 * @return 删除的记录数
	 * @throws Exception
	 */
	public int delete(int id) throws Exception {

		int result = 0;
		UserFieldDao userFieldDao = null;
		SubnetDao subnetDao = null;
		try {
			connection.setAutoCommit(false);
			userFieldDao = new UserFieldDao();
			
			userFieldDao.deleteByField(id, connection);
			//删除域时，，还需删除   用户 —域关联表中  此域的信息
			result = fieldDao.delete(id, connection);
			
			//删除域时，，还需删除该域下所有子网
			subnetDao = new SubnetDao();
			subnetDao.delete(id, connection);
			if(!connection.getAutoCommit()){
				connection.commit();
			}
		} catch (Exception e) {
			connection.rollback();
			ExceptionManage.dispose(e,this.getClass());
		} finally {
			connection.setAutoCommit(true);
		}
		return result;

	}

	/**
	 * 查询全部
	 * 
	 * @return List<Field>集合
	 * @throws Exception
	 */
	public List<Field> select() throws Exception {
		List<Field> fieldList = null;
		List<Field> resultList=null;
		Field field = null;
		SiteInstDao siteInstDao = null;
		SiteInst siteInst = null;
		List<SiteInst> siteInstList = null;
		WorkIpsDao workIpsDaO = null;
		WorkIps workIps = null;
		UserFieldDao userFieldDao=null;
		List<UserField> userFieldList=null;
		try {
			/**
			 * 登陆用户是否有查看所有域的权限
			 *   1   有
			 */
			field = new Field();
			resultList=new ArrayList<Field>();
			if(1==ConstantUtil.user.getIsAll()){
				fieldList = fieldDao.queryByCondition(field, connection);
			}else{
				//查找可以查看的域
				userFieldDao=new UserFieldDao();
				userFieldList=	userFieldDao.queryByUserField(ConstantUtil.user, connection);
				fieldList=new ArrayList<Field>();
					for(int i=0;i<userFieldList.size();i++){
						field.setId(userFieldList.get(i).getField_id());
						fieldList.addAll( fieldDao.queryByCondition(field, connection));
						
					}
			}
			if (null != fieldList && fieldList.size() != 0) {
				for (int i = 0; i < fieldList.size(); i++) {
					//加载此域下的所有网元，包括子网下的网元
					siteInst = new SiteInst();
					siteInst.setFieldID(fieldList.get(i).getId());
					siteInstDao = new SiteInstDao();
					siteInstList = siteInstDao.queryByCondition(siteInst, connection);
					fieldList.get(i).setSiteInstList(siteInstList);
					
					//
					workIpsDaO = new WorkIpsDao();
					workIps = new WorkIps();
					workIps.setField(fieldList.get(i).getId());
					fieldList.get(i).setWorkIps(workIpsDaO.queryByCondition(workIps, connection));
						resultList.add(fieldList.get(i));
					}
					
			}
		} catch (Exception e) {
			ExceptionManage.dispose(e,this.getClass());
		} finally {
			field = null;
			siteInstDao = null;
			siteInst = null;
			siteInstList = null;
		}
		return resultList;
	}

	/**
	 * 根据条件查询
	 * 
	 * @param field
	 *            查询条件
	 * @return List<Field> 集合
	 * @throws Exception
	 */
	public List<Field> select(Field field) throws Exception {
		List<Field> fieldList = null;
		SiteInstDao siteInstDao = null;
		SiteInst siteInst = null;
		List<SiteInst> siteInstList = null;
		try {
			fieldList = fieldDao.queryByCondition(field, connection);
			if (null != fieldList && fieldList.size() != 0) {
				for (int i = 0; i < fieldList.size(); i++) {
					siteInst = new SiteInst();
					siteInst.setFieldID(fieldList.get(i).getId());

					siteInstDao = new SiteInstDao();
					siteInstList = siteInstDao.queryByCondition(siteInst, connection);
					fieldList.get(i).setSiteInstList(siteInstList);
				}
			}
		} catch (Exception e) {
			ExceptionManage.dispose(e,this.getClass());
		} finally {
			siteInstDao = null;
			siteInst = null;
			siteInstList = null;
		}
		return fieldList;
	}

	/**
	 * 根据fieldID集合查询field
	 * 
	 * @param fieldids
	 *            field集合
	 * @return count
	 * @throws Exception
	 */
	public List<Field> selectfieldidByid(List<Integer> fieldids) throws Exception {

		List<Field> fields = null;
		SiteInstDao siteInstDao = null;
		SiteInst site = null;
		WorkIpsDao workIpsDaO = null;
		WorkIps workIps = null;
		try {
			fields = fieldDao.queryByidCondition(fieldids, connection);
			workIpsDaO = new WorkIpsDao();
			siteInstDao = new SiteInstDao();

			for (int i = 0; i < fields.size(); i++) {
				site = new SiteInst();
				site.setFieldID(fields.get(i).getId());
				fields.get(i).setSiteInstList(siteInstDao.queryByCondition(site, connection));
				
				workIps = new WorkIps();
				workIps.setField(fields.get(i).getId());
				fields.get(i).setWorkIps(workIpsDaO.queryByCondition(workIps, connection));
			}

		} catch (Exception e) {
			ExceptionManage.dispose(e,this.getClass());
		} finally {
			siteInstDao = null;
			site = null;
			workIpsDaO = null;
			workIps = null;
		}
		return fields;
	}

	/**
	 * 批量更新
	 * 
	 * @param fieList
	 *            域的ID集合
	 * @throws Exception
	 */
	public void updateBatch(List<Field> fieldList) throws Exception {
		if (fieldList == null) {
			throw new Exception("fieldList is null");
		}
		try {
			fieldDao.updateBatch(fieldList, connection);
		} catch (Exception e) {
			ExceptionManage.dispose(e,this.getClass());
		}
	}
	
	/**
	 * 通过域名字查找域
	 * @param name
	 * @return
	 */
	public List<Field> selectfieldidByName(String name){
		List<Field> fields = null;
		try {
			fields = fieldDao.queryByNameCondition(name,connection);
		} catch (Exception e) {
			ExceptionManage.dispose(e,this.getClass());
		}
		return fields;
		
	}
	/**
	 * 通过用户id（权限域）查找域
	 * @param name
	 * @return
	 */
	public List<Field> selectRootField(UserInst userInst){
		List<Field> fields = null;
		try {
			fields = fieldDao.queryByUserIdField(userInst,connection);
		} catch (Exception e) {
			ExceptionManage.dispose(e,this.getClass());
		}
		return fields;
		
	}
	/**
	 * 查询所有域
	 * @return
	 * @throws Exception
	 */
	public List<Field> selectField() throws Exception {
		List<Field> fieldList = null;
		Field field = null;
		WorkIpsDao workIpsDaO = new WorkIpsDao();
		try {
			field = new Field();
			fieldList = fieldDao.queryByCondition(field, connection);
			for(Field f : fieldList){
				List<String > ipList = new ArrayList<String>();
				WorkIps workIps = new WorkIps();
				workIps.setField(f.getId());
				workIps = workIpsDaO.queryByCondition(workIps, connection);
				if(workIps != null){
					if(workIps.getWorkIp1() != null && !"".equals(workIps.getWorkIp1())){
						ipList.add(workIps.getWorkIp1());
					}
					if(workIps.getWorkIp2() != null && !"".equals(workIps.getWorkIp2())){
						ipList.add(workIps.getWorkIp2());
					}
					if(workIps.getWorkIp3() != null && !"".equals(workIps.getWorkIp3())){
						ipList.add(workIps.getWorkIp3());
					}
					if(workIps.getWorkIp4() != null && !"".equals(workIps.getWorkIp4())){
						ipList.add(workIps.getWorkIp4());
					}
					if(workIps.getWorkIp5() != null && !"".equals(workIps.getWorkIp5())){
						ipList.add(workIps.getWorkIp5());
					}
					if(workIps.getWorkIp6() != null && !"".equals(workIps.getWorkIp6())){
						ipList.add(workIps.getWorkIp6());
					}
				}
				
				if(ipList.size()>0){
					f.setWorkIP(ipList);
				}
				f.setWorkIps(workIps);
			}
		} catch (Exception e) {
			ExceptionManage.dispose(e,this.getClass());
		} finally {
			field = null;
			workIpsDaO = null;
		}
		return fieldList;
	}
		
	/**
	 * 查询所有 包括域和子网
	 * @return kk
	 * @throws Exception 
	 */
	public List<Field> selectAll() throws Exception{
		return this.fieldDao.queryAll(connection);
	}

	/**
	 * 通过域名字查找域
	 * @param name
	 * @return
	 */
	public List<Field> queryByUserId(UserInst userInst){
		List<Field> fields = null;
		try {
			fields = fieldDao.queryByUserId(userInst,connection);
		} catch (Exception e) {
			ExceptionManage.dispose(e,this.getClass());
		}
		return fields;
		
	}
	
	/**
	 * 查询没有M网元的域
	 * @return
	 */
	public List<Field> queryNoMsite(){
		List<Field> fields = null;
		try {
			fields = fieldDao.queryNoMsite(connection);
		} catch (Exception e) {
			ExceptionManage.dispose(e, this.getClass());
		}
		return fields;
	}
	
	/**
	 * 通过netWorkId查询所有网元组
	 * @param netWorkId
	 * @return
	 */
	public List<Field> queryByNetWorkid(int netWorkId){
		List<Field> fields = null;
		WorkIpsDao workIpsDaO = new WorkIpsDao();
		try {
			fields = fieldDao.queryByNetWorkId(netWorkId,connection);
			for(Field f : fields){
				List<String > ipList = new ArrayList<String>();
				WorkIps workIps = new WorkIps();
				workIps.setField(f.getId());
				workIps = workIpsDaO.queryByCondition(workIps, connection);
				if(workIps != null){
					if(workIps.getWorkIp1() != null && !"".equals(workIps.getWorkIp1())){
						ipList.add(workIps.getWorkIp1());
					}
					if(workIps.getWorkIp2() != null && !"".equals(workIps.getWorkIp2())){
						ipList.add(workIps.getWorkIp2());
					}
					if(workIps.getWorkIp3() != null && !"".equals(workIps.getWorkIp3())){
						ipList.add(workIps.getWorkIp3());
					}
					if(workIps.getWorkIp4() != null && !"".equals(workIps.getWorkIp4())){
						ipList.add(workIps.getWorkIp4());
					}
					if(workIps.getWorkIp5() != null && !"".equals(workIps.getWorkIp5())){
						ipList.add(workIps.getWorkIp5());
					}
					if(workIps.getWorkIp6() != null && !"".equals(workIps.getWorkIp6())){
						ipList.add(workIps.getWorkIp6());
					}
				}
				
				if(ipList.size()>0){
					f.setWorkIP(ipList);
				}
				f.setWorkIps(workIps);
			}
		} catch (Exception e) {
			ExceptionManage.dispose(e, this.getClass());
		}
		return fields;
	}
	
	/**
	 * 验证名称是否可用
	 * @param name
	 * @return
	 */
	public boolean checkNameExist(String name){
		boolean isExist = fieldDao.checkNameExist(name, connection);
		return isExist;
	}
	
	/**
	 * 根据域i对应的域对象
	 * @param fieldId
	 * @return
	 */
	public List<Field> selectByFieldId(int fieldId){
		List<Field> fieldList = null;
		List<Integer> fieldIntegers = null;
		try {
			fieldIntegers = new ArrayList<Integer>();
			fieldIntegers.add(fieldId);
			fieldList = fieldDao.queryByidCondition(fieldIntegers, connection);
		} catch (Exception e) {
			ExceptionManage.dispose(e,this.getClass());
		} finally {
			fieldIntegers = null;
		}
		return fieldList;
	}

	/**
	 * 根据域id查询域和包含的子网
	 * @param fieldId
	 * @return
	 */
	public List<Integer> selectByFieldIds(int fieldId){
		List<Field> fieldList = null;
		List<Field> fieldGroupList = null;
		List<Integer> ids = null;
		try {
			ids = new ArrayList<Integer>();
			fieldList = this.fieldDao.selectByGroupOrParentId(fieldId, connection,0);
			if(null != fieldList && !fieldList.isEmpty())
			{
				for(Field field : fieldList)
				{
					ids.add(field.getId());
					fieldGroupList = fieldDao.selectByGroupOrParentId(field.getId(), connection,1);
					if(null != fieldGroupList && !fieldGroupList.isEmpty())
					{
					for(Field fieldGroup : fieldGroupList)
					 {
						ids.add(fieldGroup.getId());
					 }
					}
				}
			}
		} catch (Exception e) {
			ExceptionManage.dispose(e,this.getClass());
		} finally {
			fieldList = null;
			fieldGroupList = null;
		}
		return ids;
	}
}