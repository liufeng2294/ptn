package com.nms.model.ptn.port;

import java.sql.Connection;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;

import com.nms.db.bean.equipment.port.PortInst;
import com.nms.db.bean.ptn.Businessid;
import com.nms.db.bean.ptn.port.PortLagInfo;
import com.nms.db.bean.ptn.qos.QosQueue;
import com.nms.db.dao.equipment.port.PortInstDao;
import com.nms.db.dao.ptn.BusinessidDao;
import com.nms.db.dao.ptn.port.PortLagDao;
import com.nms.db.dao.ptn.qos.QosQueueDao;
import com.nms.db.enums.EActionType;
import com.nms.db.enums.EManufacturer;
import com.nms.db.enums.EServiceType;
import com.nms.model.equipment.port.PortService;
import com.nms.model.equipment.shlef.SiteService;
import com.nms.model.util.ObjectService;
import com.nms.model.util.Services;
import com.nms.ui.manager.BusinessIdException;
import com.nms.ui.manager.ConstantUtil;
import com.nms.ui.manager.ExceptionManage;

public class PortLagService extends ObjectService {
	public void setConnection(Connection connection) {
		super.connection = connection;
	}

	public void setPtnuser(String ptnuser) {
		super.ptnuser = ptnuser;
	}

	private PortLagDao portLagDao = new PortLagDao();

	public int saveOrUpdate(PortLagInfo portLagInfo) throws Exception {
		int i = 0;
		PortInst portInfo_select = null;
		List<PortInst> portList = null;
		PortInstDao portInstDao = new PortInstDao();
		BusinessidDao businessidDao = null;
		businessidDao = new BusinessidDao();
		PortService portService = null;
		if (portLagInfo == null) {
			throw new Exception("portLagInfo为空");
		}
		try {
			// 取从id管理表中取设备ID
			Businessid lagBusinessId = null;
			if (portLagInfo.getLagID() == 0) { // 如果等于0 去ID管理表查一个新值 否则去ID管理表查id对象。
				lagBusinessId = businessidDao.query(portLagInfo.getSiteId(), "lag", connection);
			} else {
				lagBusinessId = businessidDao.query(portLagInfo.getLagID(), portLagInfo.getSiteId(), "lag", connection);
			}
			if (lagBusinessId == null) {
				throw new BusinessIdException("lagBusinessId is null");
			}
			portLagInfo.setLagID(lagBusinessId.getIdValue());
			// 修改状态
			businessidDao.update(lagBusinessId.getId(), 1, connection);
			if (portLagInfo.getId() > 0) {
				portLagDao.update(portLagInfo, connection);
				i = portLagInfo.getId();
				// 离线网元数据下载
				super.dateDownLoad(portLagInfo.getSiteId(), i, EServiceType.LAG.getValue(), EActionType.UPDATE.getValue(), portLagInfo.getLagID() + "", null, portLagInfo.getPortId(), 0, null);
			} else {
				i = portLagDao.insert(portLagInfo, connection);
				portLagInfo.setId(i);
				// 离线网元数据下载
				super.dateDownLoad(portLagInfo.getSiteId(), i, EServiceType.LAG.getValue(), EActionType.INSERT.getValue(), portLagInfo.getLagID() + "", null, portLagInfo.getPortId(), 0, null);
			}
			// 修改lag时,修改端口
			portService = (PortService) ConstantUtil.serviceFactory.newService(Services.PORT, this.connection);
			portInfo_select = new PortInst();
			portInfo_select.setLagId(portLagInfo.getId());
			portInfo_select.setSiteId(portLagInfo.getSiteId());
			portList = portService.select(portInfo_select);
			if (null != portList && portList.size() > 0) {
				for (PortInst portInst : portList) {
					portInst.setLagId(0);
					portInstDao.update(portInst, connection);
				}
			}
			// 修改所选端口的lagid和角色
			for (String number : portLagInfo.getPortLagMember().split(",")) {
				if (Integer.parseInt(number) > 0) {
					PortInst portInst = new PortInst();
					portInst.setNumber(Integer.parseInt(number));
					portInst.setSiteId(portLagInfo.getSiteId());
					portInst = portInstDao.queryByCondition(portInst, connection).get(0);
					portInst.setLagId(i);
					portInstDao.update(portInst, connection);
				}
			}
		} catch (Exception e) {
			ExceptionManage.dispose(e, this.getClass());
		} finally {
//			UiUtil.closeService(portService);
		}
		return 0;
	}

	/**
	 * 查找端口高级配置
	 * 
	 * @param portLagInfo
	 * @return
	 * @throws Exception
	 */
	public List<PortLagInfo> selectPortByCondition(PortLagInfo portLagInfo) throws Exception {
		List<PortLagInfo> portLagInfoList = new ArrayList<PortLagInfo>();
		try {
			portLagInfoList = portLagDao.queryByCondition(portLagInfo, connection);
		} catch (Exception e) {
			ExceptionManage.dispose(e, this.getClass());
		}
		return portLagInfoList;
	}

	/**
	 * 查找端口高级配置
	 * 
	 * @param portLagInfo
	 * @return
	 * @throws Exception
	 */
	public List<PortLagInfo> selectByCondition(PortLagInfo portLagInfo) throws Exception {
		List<PortLagInfo> portLagInfoList = new ArrayList<PortLagInfo>();
		PortInst portInst = null;
		PortInstDao portInstDao = null;
		QosQueueDao qosQueueDao = null;
		QosQueue qosQueue = null;
		try {
			portInstDao = new PortInstDao();
			qosQueueDao = new QosQueueDao();
			portLagInfoList = portLagDao.queryByCondition(portLagInfo, connection);
			for (PortLagInfo portLagInfoSelect : portLagInfoList) {

				// 设置此lag的所有端口
				portInst = new PortInst();
				portInst.setLagId(portLagInfoSelect.getId());
				portLagInfoSelect.setPortList(portInstDao.queryByCondition(portInst, connection));

				// 设置此lag下的qos
				qosQueue = new QosQueue();
				qosQueue.setObjId(portLagInfoSelect.getId());
				qosQueue.setObjType("LAG");

				portLagInfoSelect.setQosQueueList(qosQueueDao.queryByCondition(qosQueue, connection));
			}
		} catch (Exception e) {
			ExceptionManage.dispose(e, this.getClass());
		}
		return portLagInfoList;
	}

	public void delete(List<PortLagInfo> portLagInfoList) throws Exception {
		PortInst portInst = null;
		PortInstDao portInstDao = null;
		List<PortInst> portInstList = null;
		QosQueueDao qosQueueDao = null;
		QosQueue qosQueue = null;
		Businessid businessid = null;
		BusinessidDao businessidDao = null;
		PortService portService = null;
		SiteService siteService = null;
		try {
			siteService=(SiteService) ConstantUtil.serviceFactory.newService(Services.SITE, this.connection);
			businessidDao = new BusinessidDao();
			qosQueueDao = new QosQueueDao();
			portInstDao = new PortInstDao();
			connection.setAutoCommit(false);
			for (PortLagInfo portLagInfo : portLagInfoList) {
				// 离线网元数据下载
				portService = (PortService) ConstantUtil.serviceFactory.newService(Services.PORT, this.connection);
				PortInst portInstSel = new PortInst();
				portInstSel.setLagId(portLagInfo.getId());
				List<PortInst> portInsts = portService.select(portInstSel);
				if(portInsts != null && portInsts.size() >0){
					portInst = portInsts.get(0);
					super.dateDownLoad(portLagInfo.getSiteId(), portLagInfo.getId(), EServiceType.LAG.getValue(), EActionType.DELETE.getValue(), portLagInfo.getLagID() + "", null, portInst.getPortId(), 0, null);
				}
				if (portLagInfo.getId() > 0) {
					// 查询此lag下的所有port
					portInst = new PortInst();
					portInst.setLagId(portLagInfo.getId());
					portInst.setSiteId(portLagInfo.getSiteId());
					portInstList = portInstDao.queryByCondition(portInst, connection);

					// 遍历port 把角色改成NONE lagid改成0
					for (PortInst portUpdate : portInstList) {
						portUpdate.setLagId(0);
						if (siteService.getManufacturer(portUpdate.getSiteId()) == EManufacturer.CHENXIAO.getValue()) {
							portUpdate.setPortType("NONE");
						}
						portInstDao.update(portUpdate, connection);
					}

					businessid = new Businessid();
					businessid.setIdStatus(0);
					businessid.setType("lag");
					businessid.setSiteId(portLagInfo.getSiteId());
					businessid.setIdValue(portLagInfo.getLagID());
					businessidDao.updateBusinessid(businessid, connection);

					portLagDao.delete(portLagInfo.getId(), connection);

					qosQueue = new QosQueue();
					qosQueue.setObjId(portLagInfo.getId());
					qosQueue.setObjType("LAG");
					qosQueueDao.delete(qosQueue, connection);
				}

			}

			if(!connection.getAutoCommit()){
				connection.commit();
			}
		} catch (SQLException e) {
			connection.rollback();
			ExceptionManage.dispose(e, this.getClass());
		} finally {
			connection.setAutoCommit(true);
		}
	}

	public int selectLagCountByNeId(int NeId) throws Exception {
		return portLagDao.selectCountByNeId(NeId, connection);
	}

	public int insertLag(PortLagInfo portLagInfo) throws Exception, BusinessIdException {
		int i = 0;
		PortInstDao portInstDao = null;
		QosQueueDao qosQueueDao = null;
		BusinessidDao businessidDao = null;
		try {
			businessidDao = new BusinessidDao();
			portInstDao = new PortInstDao();
			qosQueueDao = new QosQueueDao();
			connection.setAutoCommit(false);

			// 取从id管理表中取设备ID
			Businessid lagBusinessId = null;
			if (portLagInfo.getLagID() == 0) { // 如果等于0 去ID管理表查一个新值 否则去ID管理表查id对象。
				lagBusinessId = businessidDao.query(portLagInfo.getSiteId(), "lag", connection);
			} else {
				lagBusinessId = businessidDao.query(portLagInfo.getLagID(), portLagInfo.getSiteId(), "lag", connection);
			}

			if (lagBusinessId == null) {
				throw new BusinessIdException("lagBusinessId is null");
			}
			portLagInfo.setLagID(lagBusinessId.getIdValue());
			// 修改状态
			businessidDao.update(lagBusinessId.getId(), 1, connection);

			i = portLagDao.insert(portLagInfo, connection);

			// 修改所选端口的lagid和角色
			for (PortInst portinst : portLagInfo.getPortList()) {
				portinst.setPortType(portLagInfo.getRole());
				portinst.setLagId(i);

				portInstDao.update(portinst, connection);
			}

			// 新建qos
			if (null != portLagInfo.getQosQueueList() && portLagInfo.getQosQueueList().size() > 0) {
				for (QosQueue qosQueue : portLagInfo.getQosQueueList()) {
					qosQueue.setObjId(i);
					qosQueueDao.insert(qosQueue, connection);
				}
			}

			// 离线网元数据下载
			super.dateDownLoad(portLagInfo.getSiteId(), i, EServiceType.LAG.getValue(), EActionType.INSERT.getValue(), portLagInfo.getLagID() + "", null, 0, 0, null);
			if(!connection.getAutoCommit()){
				connection.commit();
			}

		} catch (BusinessIdException e) {
			connection.rollback();
			throw e;
		} catch (Exception e) {
			connection.rollback();
			ExceptionManage.dispose(e, this.getClass());
		} finally {
			connection.setAutoCommit(true);
			portInstDao = null;
		}
		return i;
	}

	/**
	 * 查找lag
	 * 
	 * @param portLagInfo
	 * @return
	 */
	public List<PortLagInfo> selectLAGByCondition(PortLagInfo portLagInfo) {
		List<PortLagInfo> portLagInfoList = new ArrayList<PortLagInfo>();
		try {
			portLagInfoList = portLagDao.queryLagByCondition(portLagInfo, connection);
		} catch (Exception e) {
			ExceptionManage.dispose(e, this.getClass());
		}
		return portLagInfoList;
	}

	/**
	 * 修改LAG
	 * 
	 * @author kk
	 * 
	 * @param
	 * 
	 * @return
	 * @throws Exception
	 * 
	 * @Exception 异常对象
	 */
	public void updateLag(PortLagInfo portLagInfo) throws Exception {
		PortLagInfo portLagInfo_select = null;
		List<PortLagInfo> portLagInfoList = null;
		PortInstDao portInstDao = null;
		QosQueueDao qosQueueDao = null;
		QosQueue qosQueue_select = null;
		List<QosQueue> qosQueueList = null;
		boolean flag_qos_insert = false;
		SiteService siteService = null;
		try {
			connection.setAutoCommit(false);
			siteService=(SiteService) ConstantUtil.serviceFactory.newService(Services.SITE, this.connection);
			portInstDao = new PortInstDao();
			qosQueueDao = new QosQueueDao();

			// 查询所有此lag修改之前的数据 修改端口用。
			portLagInfo_select = new PortLagInfo();
			portLagInfo_select.setId(portLagInfo.getId());
			portLagInfoList = this.selectByCondition(portLagInfo_select);

			if (null != portLagInfoList && portLagInfoList.size() == 1) {
				portLagInfo_select = portLagInfoList.get(0);
				for (PortInst portInst : portLagInfo_select.getPortList()) {
					portInst.setLagId(0);
					if (siteService.getManufacturer(portInst.getSiteId()) == EManufacturer.CHENXIAO.getValue()) {
						portInst.setPortType("NONE");
					}
					portInstDao.update(portInst, connection);
				}
			}

			// 修改端口状态
			for (PortInst portinst : portLagInfo.getPortList()) {
				portinst.setPortType(portLagInfo.getRole());
				portinst.setLagId(portLagInfo.getId());

				portInstDao.update(portinst, connection);
			}

			// 修改QOS 先查询此lag的qos是否存在
			qosQueue_select = new QosQueue();
			qosQueue_select.setObjId(portLagInfo.getId());
			qosQueue_select.setObjType("LAG");
			qosQueueList = qosQueueDao.queryByCondition(qosQueue_select, connection);
			if (null == qosQueueList || qosQueueList.size() == 0) {
				flag_qos_insert = true;
			}

			// 遍历此lag的qos 如果不存在就新建 如果存在就修改
			for (QosQueue qosQueue : portLagInfo.getQosQueueList()) {
				qosQueue.setObjId(portLagInfo.getId());

				if (flag_qos_insert) {
					qosQueueDao.insert(qosQueue, connection);
				} else {
					for (QosQueue qosQueueSelect : qosQueueList) {
						if (qosQueueSelect.getCos() == qosQueue.getCos()) {
							qosQueue.setId(qosQueueSelect.getId());
							break;
						}
					}
					qosQueueDao.update(qosQueue, connection);
				}
			}

			// 修改LAG
			portLagDao.update(portLagInfo, connection);

			// 离线网元数据下载
			super.dateDownLoad(portLagInfo.getSiteId(), portLagInfo.getId(), EServiceType.LAG.getValue(), EActionType.UPDATE.getValue(), portLagInfo.getLagID() + "", null, 0, 0, null);
			if(!connection.getAutoCommit()){
				connection.commit();
			}
		} catch (Exception e) {
			connection.rollback();
			throw e;
		} finally {
			connection.setAutoCommit(true);
		}
	}

	public int updateStatus(PortLagInfo portLagInfo) throws Exception {
		return portLagDao.update(portLagInfo, connection);

	}

	public int updateActiveStatus(int siteId, int value) throws Exception {
		return portLagDao.updateActiveStatus(siteId, value, connection);

	}

	public void delete(PortLagInfo portLagInfo) throws Exception {
		PortInst portInst = null;
		PortInstDao portInstDao = null;
		List<PortInst> portInstList = null;
		QosQueueDao qosQueueDao = null;
		QosQueue qosQueue = null;
		Businessid businessid = null;
		BusinessidDao businessidDao = null;
		PortService portService = null;
		SiteService siteService = null;
		try {
			siteService=(SiteService) ConstantUtil.serviceFactory.newService(Services.SITE, this.connection);
			businessidDao = new BusinessidDao();
			qosQueueDao = new QosQueueDao();
			portInstDao = new PortInstDao();
			connection.setAutoCommit(false);
			// 离线网元数据下载
			portService = (PortService) ConstantUtil.serviceFactory.newService(Services.PORT, this.connection);
			PortInst portInstSel = new PortInst();
			portInstSel.setLagId(portLagInfo.getId());
			portInstList = portService.select(portInstSel);
			if (portInstList.size() > 0) {
				portInst = portInstList.get(0);
			}
			super.dateDownLoad(portLagInfo.getSiteId(), portLagInfo.getId(), EServiceType.LAG.getValue(), EActionType.DELETE.getValue(), portLagInfo.getLagID() + "", null, portInst.getPortId(), 0, null);

			if (portLagInfo.getId() > 0) {
				// 查询此lag下的所有port
				portInst = new PortInst();
				portInst.setLagId(portLagInfo.getId());
				portInst.setSiteId(portLagInfo.getSiteId());
				portInstList = portInstDao.queryByCondition(portInst, connection);

				// 遍历port 把角色改成NONE lagid改成0
				for (PortInst portUpdate : portInstList) {
					portUpdate.setLagId(0);
					if (siteService.getManufacturer(portUpdate.getSiteId()) == EManufacturer.CHENXIAO.getValue()) {
						portUpdate.setPortType("NONE");
					}
					portInstDao.update(portUpdate, connection);
				}

				businessid = new Businessid();
				businessid.setIdStatus(0);
				businessid.setType("lag");
				businessid.setSiteId(portLagInfo.getSiteId());
				businessid.setIdValue(portLagInfo.getLagID());
				businessidDao.updateBusinessid(businessid, connection);

				portLagDao.delete(portLagInfo.getId(), connection);

				qosQueue = new QosQueue();
				qosQueue.setObjId(portLagInfo.getId());
				qosQueue.setObjType("LAG");
				qosQueueDao.delete(qosQueue, connection);
			}

			if(!connection.getAutoCommit()){
				connection.commit();
			}
		} catch (SQLException e) {
			connection.rollback();
			ExceptionManage.dispose(e, this.getClass());
		} finally {
			connection.setAutoCommit(true);
		}
	}

	/**
	 * 同步中搜索lag
	 * 
	 * @param portLagInfo
	 * @return
	 * @throws Exception
	 */
	public List<PortLagInfo> selectByConditionForSynchro(PortLagInfo portLagInfo) throws Exception {
		List<PortLagInfo> portLagInfoList = new ArrayList<PortLagInfo>();
		PortInst portInst = null;
		PortInstDao portInstDao = null;
		QosQueueDao qosQueueDao = null;
		QosQueue qosQueue = null;
		try {
			portInstDao = new PortInstDao();
			qosQueueDao = new QosQueueDao();
			portLagInfoList = portLagDao.selectByConditionForSynchro(portLagInfo, connection);
			for (PortLagInfo portLagInfoSelect : portLagInfoList) {

				// 设置此lag的所有端口
				portInst = new PortInst();
				portInst.setLagId(portLagInfoSelect.getId());
				portLagInfoSelect.setPortList(portInstDao.queryByCondition(portInst, connection));

				// 设置此lag下的qos
				qosQueue = new QosQueue();
				qosQueue.setObjId(portLagInfoSelect.getId());
				qosQueue.setObjType("LAG");

				portLagInfoSelect.setQosQueueList(qosQueueDao.queryByCondition(qosQueue, connection));
			}
		} catch (Exception e) {
			ExceptionManage.dispose(e, this.getClass());
		}
		return portLagInfoList;
	}

	/**
	 * 根据lag主键查询lag名称。 显示用
	 * 
	 * @author kk
	 * 
	 * @return
	 * @throws Exception
	 * 
	 * @Exception 异常对象
	 */
	public String getLagName(int lagId) throws Exception {
		PortLagInfo portLagInfo = null;
		List<PortLagInfo> portlagInfoList = null;
		try {

			portLagInfo = new PortLagInfo();
			portLagInfo.setId(lagId);
			portlagInfoList = this.selectByCondition(portLagInfo);

			if (null != portlagInfoList && portlagInfoList.size() == 1) {
				return "lag/" + portlagInfoList.get(0).getLagID();
			} else {
				throw new Exception("查询lag出错");
			}
		} catch (Exception e) {
			throw e;
		}
	}

}
