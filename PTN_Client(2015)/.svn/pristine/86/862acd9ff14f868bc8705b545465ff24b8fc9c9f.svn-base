package com.nms.ui.ptn.ne.l2cp.controller;

import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.util.List;

import com.nms.db.bean.ptn.L2cpInfo;
import com.nms.db.enums.EOperationLogType;
import com.nms.model.ptn.L2CPService;
import com.nms.model.util.Services;
import com.nms.rmi.ui.util.RmiKeys;
import com.nms.ui.manager.ConstantUtil;
import com.nms.ui.manager.DialogBoxUtil;
import com.nms.ui.manager.DispatchUtil;
import com.nms.ui.manager.ExceptionManage;
import com.nms.ui.manager.MyActionListener;
import com.nms.ui.manager.UiUtil;
import com.nms.ui.ptn.ne.l2cp.view.L2cpPanel;

public class L2cpController {

	private L2cpPanel view ;
	
	public L2cpController(L2cpPanel view){
		this.view = view;
		addListention();
		try {
			init();
		} catch (Exception e) {
			ExceptionManage.dispose(e, getClass());
		}
	}

	private void addListention() {
		this.view.getConfirm().addActionListener(new MyActionListener() {
			
			@Override
			public void actionPerformed(ActionEvent e) {
				confirm();
			}

			@Override
			public boolean checking() {
				// TODO Auto-generated method stub
				return true;
			}
		});
		
        this.view.getSyncbutton().addActionListener(new MyActionListener() {
			
			@Override
			public void actionPerformed(ActionEvent e) {
				sync();
			}

			@Override
			public boolean checking() {
				// TODO Auto-generated method stub
				return true;
			}
		});
		
		
	}

	private void init() {
		L2CPService l2cpService = null;
		List<L2cpInfo> l2cpList = null;
		L2cpInfo L2cpInfo = null;
		try {
			l2cpService = (L2CPService)ConstantUtil.serviceFactory.newService(Services.L2CPSERVICE);
			l2cpList = l2cpService.selectAll(ConstantUtil.siteId);
			if(l2cpList != null && !l2cpList.isEmpty()){
				L2cpInfo = l2cpList.get(0);
				this.view.refresh(L2cpInfo);
			}
		} catch (Exception e) {
			ExceptionManage.dispose(e, getClass());
		}finally{
			UiUtil.closeService(l2cpService);
		}
	}
	
//创建L2CP业务
	private void confirm() {
		L2CPService l2cpService = null;
		L2cpInfo l2cpInfo = null;
		DispatchUtil l2cpDispatch = null;
		String result = "";
		try {
			l2cpService = (L2CPService)ConstantUtil.serviceFactory.newService(Services.L2CPSERVICE);
			l2cpInfo = new L2cpInfo();
			this.view.get(l2cpInfo);
			l2cpDispatch = new DispatchUtil(RmiKeys.RMI_L2CPSERVICE);
			//更新
			if(!l2cpService.selectAll(ConstantUtil.siteId).isEmpty()){
				result = l2cpDispatch.excuteUpdate(l2cpInfo);
				UiUtil.insertOperationLog(EOperationLogType.L2CPUPDATE.getValue(),result);
			}
			//增加
			else{
				result = l2cpDispatch.excuteInsert(l2cpInfo);
				UiUtil.insertOperationLog(EOperationLogType.L2CPINSERT.getValue(),result); 
			}
			DialogBoxUtil.succeedDialog(this.view, result);
		} catch (Exception e) {
			ExceptionManage.dispose(e, getClass());
		}finally{
			UiUtil.closeService(l2cpService);
			l2cpDispatch = null;
		}
	}
	
	
	private void sync() {
		DispatchUtil l2cpDispath = null;
		try {
			
			l2cpDispath = new DispatchUtil(RmiKeys.RMI_L2CPSERVICE);
			String result = l2cpDispath.synchro(ConstantUtil.siteId);
			DialogBoxUtil.succeedDialog(null, result);
			//添加日志记录
			UiUtil.insertOperationLog(EOperationLogType.SYNCL2CP.getValue(),result);
			this.init();
		} catch (Exception e) {
			ExceptionManage.dispose(e,this.getClass());
		} finally {
			l2cpDispath = null;
		}
		
		
	}
}
